"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[477],{4477:()=>{let e=(e,t,r)=>Math.max(t,Math.min(r,e));class t{createShader(e,t){let r=this.gl.createShader(e);if(!r)throw Error("shader alloc failed");if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){let e=this.gl.getShaderInfoLog(r)||"unknown shader error";try{this.gl.deleteShader(r)}catch(e){}throw Error(e)}return r}createProgram(e,t){let r=this.createShader(this.gl.VERTEX_SHADER,e),a=this.createShader(this.gl.FRAGMENT_SHADER,t),i=this.gl.createProgram();if(!i)throw Error("program alloc failed");if(this.gl.attachShader(i,r),this.gl.attachShader(i,a),this.gl.linkProgram(i),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){let e=this.gl.getProgramInfoLog(i)||"unknown program error";try{this.gl.deleteProgram(i)}catch(e){}try{this.gl.deleteShader(r)}catch(e){}try{this.gl.deleteShader(a)}catch(e){}throw Error(e)}try{this.gl.deleteShader(r)}catch(e){}try{this.gl.deleteShader(a)}catch(e){}return i}createTexture(e,t){let r=this.gl.createTexture();if(!r)throw Error("texture alloc failed");return this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),r}initializeGL(){this.program=this.createProgram("#version 300 es\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_texCoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texCoord = a_texCoord;\n}","#version 300 es\nprecision highp float;\n\nin vec2 v_texCoord;\nout vec4 fragColor;\n\nuniform sampler2D u_image;\nuniform vec2 u_resolution; // source texture size in pixels\n\n// Edge-aware blur controls\nuniform float u_blurRadius; // 0..8\nuniform float u_blurAmount; // 0..1\n\n// Color adjustments\nuniform float u_saturation; // 0..2 (1=no change)\nuniform float u_warmth;     // -1..1\nuniform float u_tint;       // -1..1\nuniform float u_brightness; // 0..2 (1=no change)\n\nfloat luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }\n\nvec2 sobel(vec2 uv, vec2 texel){\n    float tl = luma(texture(u_image, uv + texel*vec2(-1.0,-1.0)).rgb);\n    float  l = luma(texture(u_image, uv + texel*vec2(-1.0, 0.0)).rgb);\n    float bl = luma(texture(u_image, uv + texel*vec2(-1.0, 1.0)).rgb);\n    float  t = luma(texture(u_image, uv + texel*vec2( 0.0,-1.0)).rgb);\n    float  c = luma(texture(u_image, uv).rgb);\n    float  b = luma(texture(u_image, uv + texel*vec2( 0.0, 1.0)).rgb);\n    float tr = luma(texture(u_image, uv + texel*vec2( 1.0,-1.0)).rgb);\n    float  r = luma(texture(u_image, uv + texel*vec2( 1.0, 0.0)).rgb);\n    float br = luma(texture(u_image, uv + texel*vec2( 1.0, 1.0)).rgb);\n    float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;\n    float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;\n    return vec2(gx, gy);\n}\n\nvec3 gaussianBlur(vec2 uv, vec2 texel, int radius, float sigma){\n    if (radius <= 0) return texture(u_image, uv).rgb;\n    float twoSigma2 = 2.0 * sigma * sigma;\n    vec3 sum = vec3(0.0);\n    float wsum = 0.0;\n    for (int dy=-8; dy<=8; ++dy){\n        if (abs(dy) > radius) continue;\n        for (int dx=-8; dx<=8; ++dx){\n            if (abs(dx) > radius) continue;\n            vec2 d = vec2(float(dx), float(dy));\n            float w = exp(-dot(d,d)/twoSigma2);\n            sum += w * texture(u_image, uv + d*texel).rgb;\n            wsum += w;\n        }\n    }\n    return (wsum > 0.0) ? (sum/wsum) : texture(u_image, uv).rgb;\n}\n\nvoid main(){\n    vec2 uv = v_texCoord;\n    vec2 texel = 1.0 / u_resolution;\n    vec3 src = texture(u_image, uv).rgb;\n\n    // Edge-aware blur: blur flat zones more than edges\n    float r = clamp(u_blurRadius, 0.0, 8.0);\n    int ri = int(floor(r + 1e-3));\n    vec3 blurred = gaussianBlur(uv, texel, ri, max(0.5, r));\n    vec2 g = sobel(uv, texel);\n    float gmag = length(g);\n    // Normalize local edge strength approximately using a soft response\n    float edge = clamp(gmag * 2.0, 0.0, 1.0);\n    float wMix = clamp(u_blurAmount, 0.0, 1.0) * (1.0 - edge) * (1.0 - edge);\n    vec3 col = mix(src, blurred, wMix);\n\n    // Saturation: lerp between gray and color\n    float L = luma(col);\n    float sat = clamp(u_saturation, 0.0, 2.0);\n    col = mix(vec3(L), col, sat);\n\n    // Warmth/tint biases\n    float warm = clamp(u_warmth, -1.0, 1.0);\n    float ti = clamp(u_tint, -1.0, 1.0);\n    col.r += 0.10 * warm; col.b -= 0.10 * warm;\n    col.g += -0.08 * ti; col.r += 0.04 * ti; col.b += 0.04 * ti;\n\n    // Brightness\n    col *= clamp(u_brightness, 0.0, 2.0);\n    col = clamp(col, 0.0, 1.0);\n    fragColor = vec4(col, 1.0);\n}");let e=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);if(this.quadBuffer=this.gl.createBuffer(),!this.quadBuffer)throw Error("quad buffer alloc failed");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);let t=this.gl;if(this.vao=t.createVertexArray(),!this.vao)throw Error("vao alloc failed");t.bindVertexArray(this.vao);let r=this.gl.getAttribLocation(this.program,"a_position"),a=this.gl.getAttribLocation(this.program,"a_texCoord");if(this.gl.enableVertexAttribArray(r),this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(r,2,this.gl.FLOAT,!1,16,0),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,8),t.bindVertexArray(null),this.framebuffer||(this.framebuffer=this.gl.createFramebuffer()),!this.framebuffer)throw Error("framebuffer alloc failed");if(this.inputTexture||(this.inputTexture=this.gl.createTexture()),!this.inputTexture)throw Error("input texture alloc failed")}async applyPreprocess(t,r,a){var i,l,n,s,o,h;if(!r.enabled)return new ImageData(new Uint8ClampedArray(t.data),t.width,t.height);if(this.contextLost||this.gl.isContextLost())throw Error("WebGL context lost");if(null==a?void 0:a.aborted)throw Error("Operation cancelled");let u=t.width,f=t.height;if(!this.program||!this.vao||!this.framebuffer||!this.inputTexture)throw Error("preprocess shader unavailable");if(this.gl.bindTexture(this.gl.TEXTURE_2D,this.inputTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,u,f,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.data),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.outputTexture){try{this.gl.deleteTexture(this.outputTexture)}catch(e){}this.outputTexture=null}if(this.outputTexture=this.createTexture(u,f),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.outputTexture,0),this.gl.drawBuffers([this.gl.COLOR_ATTACHMENT0]),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!==this.gl.FRAMEBUFFER_COMPLETE)throw Error("preprocess FBO incomplete");this.gl.viewport(0,0,u,f),this.gl.disable(this.gl.BLEND),this.gl.useProgram(this.program),this.gl.bindVertexArray(this.vao),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.inputTexture);let c=e=>this.gl.getUniformLocation(this.program,e);if(this.gl.uniform1i(c("u_image"),0),this.gl.uniform2f(c("u_resolution"),u,f),this.gl.uniform1f(c("u_blurRadius"),e(Math.floor(null!=(i=r.blurRadius)?i:0),0,8)),this.gl.uniform1f(c("u_blurAmount"),e(null!=(l=r.blurAmount)?l:0,0,1)),this.gl.uniform1f(c("u_saturation"),e(null!=(n=r.saturation)?n:1,0,2)),this.gl.uniform1f(c("u_warmth"),e(null!=(s=r.warmth)?s:0,-1,1)),this.gl.uniform1f(c("u_tint"),e(null!=(o=r.tint)?o:0,-1,1)),this.gl.uniform1f(c("u_brightness"),e(null!=(h=r.brightness)?h:1,0,2)),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),null==a?void 0:a.aborted)throw Error("Operation cancelled");let g=new Uint8ClampedArray(u*f*4);return this.gl.readPixels(0,0,u,f,this.gl.RGBA,this.gl.UNSIGNED_BYTE,g),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),new ImageData(g,u,f)}destroy(){try{this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindVertexArray(null)}catch(e){}if(this.quadBuffer){try{this.gl.deleteBuffer(this.quadBuffer)}catch(e){}this.quadBuffer=null}if(this.vao){try{this.gl.deleteVertexArray(this.vao)}catch(e){}this.vao=null}if(this.program){try{this.gl.deleteProgram(this.program)}catch(e){}this.program=null}if(this.framebuffer){try{this.gl.deleteFramebuffer(this.framebuffer)}catch(e){}this.framebuffer=null}if(this.inputTexture){try{this.gl.deleteTexture(this.inputTexture)}catch(e){}this.inputTexture=null}if(this.outputTexture){try{this.gl.deleteTexture(this.outputTexture)}catch(e){}this.outputTexture=null}try{this.canvasEl.width=0,this.canvasEl.height=0}catch(e){}}constructor(e){this.contextLost=!1,this.program=null,this.vao=null,this.quadBuffer=null,this.framebuffer=null,this.inputTexture=null,this.outputTexture=null,(0===e.width||0===e.height)&&(e.width=256,e.height=256);let t=e.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1});if(!t)throw Error("WebGL2 is required but not supported by your browser/system");this.gl=t,this.canvasEl=e;let r=this.canvasEl;"addEventListener"in r&&(r.addEventListener("webglcontextlost",e=>{try{e.preventDefault()}catch(e){}this.contextLost=!0},{passive:!1}),r.addEventListener("webglcontextrestored",()=>{this.contextLost=!1;try{this.initializeGL()}catch(e){}})),this.initializeGL()}}let r={src:"/atelier-of-the-painter//_next/static/media/01.7889cc4d.png"},a=(e,t,r)=>Math.max(t,Math.min(r,e)),i=(e,t)=>{if(!(t>0))return 0;let r=2*t,a=e%r;return a<0&&(a+=r),a>t&&(a=r-a),a},l=(e,t,r)=>e+(t-e)*r,n=(e,t,r)=>{if(e===t)return r<e?0:1;let i=a((r-e)/(t-e),0,1);return i*i*(3-2*i)};function s(e,t){let r=Math.abs(0|e),a=Math.abs(0|t);for(;0!==a;){let e=r%a;r=a,a=e}return r}function o(e,t,r){let i=a(Math.floor(t),0,e.width-1),l=(a(Math.floor(r),0,e.height-1)*e.width+i)*4,n=e.data;return[n[l],n[l+1],n[l+2],n[l+3]]}function h(e,t,r,i,l){let n=a(i,1,t-2),s=a(l,1,r-2)*t+n,o=e[s-1],h=e[s+1],u=e[s-t],f=e[s+t],c=(h-o)*.5,g=(f-u)*.5,d=Math.sqrt(c*c+g*g);return{gx:c,gy:g,mag:d}}class u{compileShader(e,t){let r=this.gl,a=r.createShader(e);if(!a)throw Error("shader alloc failed");if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS)){let e=r.getShaderInfoLog(a)||"";throw r.deleteShader(a),Error("shader compile failed: ".concat(e))}return a}linkProgram(e,t){let r=this.gl,a=r.createProgram();if(!a)throw Error("program alloc failed");if(r.attachShader(a,e),r.attachShader(a,t),r.linkProgram(a),!r.getProgramParameter(a,r.LINK_STATUS)){let e=r.getProgramInfoLog(a)||"";throw r.deleteProgram(a),Error("program link failed: ".concat(e))}return a}init(){let e=this.gl,t=this.compileShader(e.VERTEX_SHADER,"#version 300 es\nprecision highp float;\n\nin vec2 a_pos;\n\n// Per-instance attributes\nin vec2 a_centerPx;\nin vec2 a_sizePx;\nin float a_angle;\nin vec4 a_color;\n\nuniform vec2 u_resolution;\n\nout vec2 v_local;\nout vec4 v_color;\n\nvoid main() {\n  // a_pos is in [-1,1] quad space\n  v_local = a_pos;\n  v_color = a_color;\n\n  float c = cos(a_angle);\n  float s = sin(a_angle);\n  mat2 R = mat2(c, -s, s, c);\n\n  // Local quad coordinate scaled to pixels (half-extents)\n  vec2 halfSize = 0.5 * a_sizePx;\n  vec2 offsetPx = R * (a_pos * halfSize);\n\n  vec2 px = a_centerPx + offsetPx;\n\n  // Convert pixel coords (top-left origin) to clip space\n  vec2 ndc;\n  ndc.x = (px.x / u_resolution.x) * 2.0 - 1.0;\n  ndc.y = 1.0 - (px.y / u_resolution.y) * 2.0;\n\n  gl_Position = vec4(ndc, 0.0, 1.0);\n}"),r=this.compileShader(e.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\n\nin vec2 v_local;\nin vec4 v_color;\n\nout vec4 fragColor;\n\nuniform float u_opacity;\nuniform sampler2D u_brushTex;\nuniform float u_useBrushTex;\nuniform float u_brushStrength;\nuniform float u_brushDecodeMode;\nuniform float u_debugPaint;\n\nfloat hash12(vec2 p) {\n  vec3 p3 = fract(vec3(p.xyx) * 0.1031);\n  p3 += dot(p3, p3.yzx + 33.33);\n  return fract((p3.x + p3.y) * p3.z);\n}\n\nvoid main() {\n  // v_local ranges roughly [-1,1]\n  // Analytic fallback mask (only used if no brush texture is available).\n  // Use a *square* falloff so non-uniform scaling doesn't turn it into an obvious oval.\n  float edge = max(abs(v_local.x), abs(v_local.y));\n  float a0 = 1.0 - smoothstep(0.92, 1.0, edge);\n\n  // Add slight bristle noise to edge.\n  float n = hash12(gl_FragCoord.xy * 0.75);\n  a0 *= mix(0.95, 1.0, n);\n\n  float texMask = 1.0;\n\n  // Optional texture-driven brush mask.\n  // v_local is brush-space, so this naturally rotates with the stroke geometry.\n  if (u_useBrushTex > 0.5) {\n    vec2 uv = v_local * 0.5 + 0.5;\n    // Keep in range to avoid undefined filtering on exact borders.\n    uv = clamp(uv, vec2(0.001), vec2(0.999));\n    vec4 bt = texture(u_brushTex, uv);\n    float lum = dot(bt.rgb, vec3(0.299, 0.587, 0.114));\n    // Decode modes: 0=alpha, 1=luma, 2=inverted luma, 3=inverted alpha.\n    float b = bt.a;\n    if (u_brushDecodeMode > 2.5) {\n      b = 1.0 - bt.a;\n    } else if (u_brushDecodeMode > 1.5) {\n      b = 1.0 - lum;\n    } else if (u_brushDecodeMode > 0.5) {\n      b = lum;\n    }\n    texMask = clamp(b, 0.0, 1.0);\n    // Strength controls contrast/ink amount, but the texture still defines silhouette.\n    float gamma = mix(2.2, 0.8, clamp(u_brushStrength, 0.0, 1.0));\n    texMask = pow(texMask, gamma);\n  }\n\n  // IMPORTANT: When using a brush texture, let the texture define the silhouette.\n  // Multiplying by an analytic radial mask forces an oval when the quad is stretched.\n  float mask = (u_useBrushTex > 0.5) ? texMask : a0;\n  mask = clamp(mask, 0.0, 1.0);\n\n  if (u_debugPaint > 0.5) {\n    // Debug view: show silhouette mask, colored by the per-stroke debug color.\n    fragColor = vec4(v_color.rgb * mask, 1.0);\n    return;\n  }\n\n  float alpha = clamp(mask * u_opacity * v_color.a, 0.0, 1.0);\n  // Premultiplied-alpha output for better compositing (reduces halos).\n  fragColor = vec4(v_color.rgb * alpha, alpha);\n}"),a=this.linkProgram(t,r);e.deleteShader(t),e.deleteShader(r),this.program=a;{let t=this.compileShader(e.VERTEX_SHADER,"#version 300 es\nprecision highp float;\n\nin vec2 a_pos;\nout vec2 v_uv;\n\nvoid main(){\n  // a_pos in [-1,1]\n  v_uv = a_pos * 0.5 + 0.5;\n  gl_Position = vec4(a_pos, 0.0, 1.0);\n}"),r=this.compileShader(e.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 fragColor;\n\nuniform sampler2D u_tex;\n\nvoid main(){\n  // Our CPU ImageData uses a top-left origin; WebGL textures sample with bottom-left UVs.\n  fragColor = texture(u_tex, vec2(v_uv.x, 1.0 - v_uv.y));\n}"),a=this.linkProgram(t,r);e.deleteShader(t),e.deleteShader(r),this.blitProgram=a}if(this.vao=e.createVertexArray(),this.blitVao=e.createVertexArray(),this.quadBuffer=e.createBuffer(),this.instanceCenter=e.createBuffer(),this.instanceSize=e.createBuffer(),this.instanceAngle=e.createBuffer(),this.instanceColor=e.createBuffer(),!this.vao||!this.blitVao||!this.quadBuffer||!this.instanceCenter||!this.instanceSize||!this.instanceAngle||!this.instanceColor)throw Error("buffer alloc failed");e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer);let i=new Float32Array([-1,-1,1,-1,-1,1,1,1]);e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW);let l=e.getAttribLocation(a,"a_pos");e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,0,0);let n=(t,r,i,l,n)=>{let s=e.getAttribLocation(a,t);if(s<0)throw Error("missing attrib ".concat(t));e.bindBuffer(e.ARRAY_BUFFER,r),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,i,l,n,0,0),e.vertexAttribDivisor(s,1)};n("a_centerPx",this.instanceCenter,2,e.FLOAT,!1),n("a_sizePx",this.instanceSize,2,e.FLOAT,!1),n("a_angle",this.instanceAngle,1,e.FLOAT,!1),n("a_color",this.instanceColor,4,e.FLOAT,!1),e.bindVertexArray(null),e.bindVertexArray(this.blitVao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer);let s=e.getAttribLocation(this.blitProgram,"a_pos");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.bindVertexArray(null)}ensureTarget(e,t){let r=this.gl;if(this.rtW!==e||this.rtH!==t||!this.framebuffer||!this.colorTex){if(this.rtW=e,this.rtH=t,this.canvas.width=e,this.canvas.height=t,this.framebuffer){try{r.deleteFramebuffer(this.framebuffer)}catch(e){}this.framebuffer=null}if(this.colorTex){try{r.deleteTexture(this.colorTex)}catch(e){}this.colorTex=null}if(this.targetTex){try{r.deleteTexture(this.targetTex)}catch(e){}this.targetTex=null}if(this.framebuffer=r.createFramebuffer(),this.colorTex=r.createTexture(),this.targetTex=r.createTexture(),!this.framebuffer||!this.colorTex||!this.targetTex)throw Error("rt alloc failed");if(r.bindTexture(r.TEXTURE_2D,this.colorTex),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.colorTex,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)throw Error("paint framebuffer incomplete");r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindTexture(r.TEXTURE_2D,null)}}async ensureBrushTextures(){this.brushTextures.length>0||(this.brushLoadPromise||(this.brushLoadPromise=this.loadBrushTextures()),await this.brushLoadPromise)}async loadBrushTextures(){let e=this.gl,t=[r.src],a=[],i=[];for(let r of t)try{let t=f(r),l=await fetch(t);if(!l.ok){try{console.warn("[Paint] Brush fetch failed: ".concat(l.status," ").concat(l.statusText," (").concat(t,")"))}catch(e){}continue}let n=await l.blob(),s=await createImageBitmap(n),o=e.createTexture();if(!o){try{s.close()}catch(e){}continue}let h=this.analyzeBrushBitmap(s);e.bindTexture(e.TEXTURE_2D,o),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null);try{s.close()}catch(e){}a.push(o),i.push(h);try{console.info("[Paint] Loaded brush: ".concat(t," (decodeMode=").concat(h,")"))}catch(e){}}catch(e){try{let e=f(r.startsWith("/")?function(e){try{let t="/atelier-of-the-painter".replace(/\/$/,"");if(!e)return t||"/";let r=e.startsWith("/")?e:"/".concat(e);return"".concat(t).concat(r)||r}catch(t){return e.startsWith("/")?e:"/".concat(e)}}(r):r);console.warn("[Paint] Brush fetch threw; falling back (url=".concat(e,")"))}catch(e){}}if(0===a.length){let e=this.createFallbackBrushTexture(96,96);if(e){try{console.warn("[Paint] Brush texture(s) missing; using generated fallback brush mask.")}catch(e){}a.push(e),i.push(0)}}this.brushTextures=a,this.brushDecodeModes=i}analyzeBrushBitmap(e){try{let t=Math.max(1,Math.min(128,e.width)),r=Math.max(1,Math.min(128,e.height)),a=new OffscreenCanvas(t,r).getContext("2d",{willReadFrequently:!0});if(!a)return 0;a.clearRect(0,0,t,r),a.drawImage(e,0,0,t,r);let i=a.getImageData(0,0,t,r).data,l=1,n=0,s=1,o=0,h=0,u=Math.max(1,t*r);for(let e=0;e<i.length;e+=4){let t=i[e+3]/255,r=(.299*i[e]+.587*i[e+1]+.114*i[e+2])/255;l=Math.min(l,t),n=Math.max(n,t),s=Math.min(s,r),o=Math.max(o,r),h+=r}let f=n-l,c=o-s,g=h/u;if(f>.2)return 0;if(c>.15)return g>.5?2:1;return 0}catch(e){return 0}}createFallbackBrushTexture(e,t){let r=this.gl,a=r.createTexture();if(!a)return null;let i=new Uint8Array(e*t*4);for(let r=0;r<t;r++){let a=(r+.5)/t*2-1;for(let t=0;t<e;t++){let l=(t+.5)/e*2-1,n=Math.sqrt(l*l+a*a),s=(r*e+t)*4;if(n>1){i[s+0]=0,i[s+1]=0,i[s+2]=0,i[s+3]=0;continue}let o=Math.floor(255*Math.max(0,Math.min(1,(1-Math.min(1,Math.max(0,(n-.72)/.28)))*(.78+.22*Math.sin((18*l+5*a)*3.14159265)))));i[s+0]=o,i[s+1]=o,i[s+2]=o,i[s+3]=o}}return r.bindTexture(r.TEXTURE_2D,a),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),a}async render(e,t,r,u,f){var c,g,d,m,E;let x,T=this.gl;if(!this.program||!this.vao)throw Error("paint program not initialized");await this.ensureBrushTextures();let p=e.width,_=e.height;this.ensureTarget(p,_);let b=(x=t.seed>>>0||1,()=>(0|(x=1664525*x+0x3c6ef35f>>>0))/0x100000000),A=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,r=Math.min(1,t/Math.max(1,Math.max(e.width,e.height))),a=Math.max(8,Math.floor(e.width*r)),i=Math.max(8,Math.floor(e.height*r)),l=new Float32Array(a*i);for(let t=0;t<i;t++){let r=(t+.5)*(e.height/i)-.5;for(let i=0;i<a;i++){let n=(i+.5)*(e.width/a)-.5,[s,h,u]=o(e,n,r);l[t*a+i]=(.2126*s+.7152*h+.0722*u)/255}}return{lum:l,w:a,h:i}}(e,256),M=null;if(f){let e=new Float32Array(A.w*A.h);for(let t=0;t<A.h;t++){let r=(t+.5)*(f.height/A.h)-.5;for(let i=0;i<A.w;i++){let l=(i+.5)*(f.width/A.w)-.5;e[t*A.w+i]=function(e,t,r){let i=a(Math.floor(t),0,e.width-1),l=(a(Math.floor(r),0,e.height-1)*e.width+i)*4;return e.data[l]/255}(f,l,r)}}M=e}let R=1e-6;for(let e=0;e<512;e++){let e=Math.floor(b()*(A.w-2))+1,t=Math.floor(b()*(A.h-2))+1;R=Math.max(R,h(A.lum,A.w,A.h,e,t).mag)}T.bindFramebuffer(T.FRAMEBUFFER,this.framebuffer),T.viewport(0,0,p,_);let v=!!t.debugMask;if(v&&(T.disable(T.BLEND),T.clearColor(0,0,0,1),T.clear(T.COLOR_BUFFER_BIT)),!this.blitProgram||!this.blitVao||!this.targetTex)throw Error("paint blit program not initialized");if(!v){T.disable(T.BLEND),T.useProgram(this.blitProgram),T.bindVertexArray(this.blitVao),T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,this.targetTex),T.pixelStorei(T.UNPACK_ALIGNMENT,4),T.texImage2D(T.TEXTURE_2D,0,T.RGBA,p,_,0,T.RGBA,T.UNSIGNED_BYTE,e.data),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,T.CLAMP_TO_EDGE);let t=T.getUniformLocation(this.blitProgram,"u_tex");t&&T.uniform1i(t,0),T.drawArrays(T.TRIANGLE_STRIP,0,4)}v?T.disable(T.BLEND):(T.enable(T.BLEND),T.blendEquation(T.FUNC_ADD),T.blendFunc(T.ONE,T.ONE_MINUS_SRC_ALPHA)),T.useProgram(this.program),T.bindVertexArray(this.vao);let y=T.getUniformLocation(this.program,"u_resolution");y&&T.uniform2f(y,p,_);let w=T.getUniformLocation(this.program,"u_opacity"),D=T.getUniformLocation(this.program,"u_brushTex"),U=T.getUniformLocation(this.program,"u_useBrushTex"),P=T.getUniformLocation(this.program,"u_brushStrength"),F=T.getUniformLocation(this.program,"u_brushDecodeMode"),I=T.getUniformLocation(this.program,"u_debugPaint");I&&T.uniform1f(I,+!!v);let B=Math.max(1,Math.min(6,Math.round(t.layers))),L=Math.max(1,t.baseBrushPx),S=a(null!=(c=t.minBrushPx)?c:1,1,L),C=a(Math.round(null!=(g=t.strokeLength)?g:18),3,64),N=a(null!=(d=t.strokeOverlap)?d:.72,.05,.95),q=[1,.583,.354,.229,.158,.117].slice(0,B);for(let f=0;f<q.length;f++){if(null==u?void 0:u.aborted)throw Error("Operation cancelled");let c=q[f],g=a(L*c,1,512),d=a(S*c,1,512),x=.75/1.35,y=a(.75/1.35*g,1,512),I=a(d*x,1,512),B=Math.max(2,.48*g)/a(t.density,.25,2),X=this.brushTextures.length>0,G=X?this.brushTextures[Math.min(f,this.brushTextures.length-1)]:null,k=X&&null!=(E=this.brushDecodeModes[Math.min(f,this.brushDecodeModes.length-1)])?E:0;if(U&&T.uniform1f(U,+!!X),F&&T.uniform1f(F,k),P){let e=a(.45+f/Math.max(1,q.length-1)*.4,0,1);T.uniform1f(P,e)}X&&G&&(T.activeTexture(T.TEXTURE1),T.bindTexture(T.TEXTURE_2D,G),D&&T.uniform1i(D,1));let O=Math.ceil(p/B),V=Math.ceil(_/B),W=O*V*(M?2:1)*((f<2?1:.82)*C*.72),z=Math.min(26e4,Math.max(8e3,Math.floor(.7*W))),Y=Math.min(35e4,Math.max(8e3,Math.floor(1.2*z))),H=Math.min(1,z/Math.max(1,W)),K=new Float32Array(2*Y),j=new Float32Array(2*Y),Q=new Float32Array(Y),$=new Float32Array(4*Y),J=0,Z=(e,t,r,a,i,l,n,s,o)=>{!(J>=Y)&&(K[2*J+0]=e,K[2*J+1]=t,j[2*J+0]=r,j[2*J+1]=a,Q[J]=i,$[4*J+0]=l,$[4*J+1]=n,$[4*J+2]=s,$[4*J+3]=o,J++)},ee=O*V,et=function(e,t){if(!(e>1))return 1;let r=1+Math.floor(t()*(e-1));for(let t=0;t<24&&1!==s(r,e);t++)++r>=e&&(r=1);return 1!==s(r,e)&&(r=e-1),r}(ee,b),er=Math.floor(b()*ee);for(let r=0;r<ee&&J<Y;r++){let s=(er+r*et)%ee,u=s%O,c=(s-u)/O;if(b()>H)continue;let m=(u+.5)*B,E=(c+.5)*B,T=.5*a(t.jitter,0,1),w=i(m+(2*b()-1)*T*B,p-1),D=i(E+(2*b()-1)*T*B,_-1),U=w/p*(A.w-1),P=D/_*(A.h-1),F=Math.floor(U),L=Math.floor(P),S=h(A.lum,A.w,A.h,F,L),X=a(S.mag/R,0,1),G=a(Math.pow(M?M[L*A.w+F]:X,.72),0,1),k=Math.atan2(S.gy,S.gx)+.5*Math.PI,V=n(0,1,function(e,t){let r=a(t.depthSizeStart,0,1),i=a(t.depthSizeEnd,0,1),l=Math.max(1e-6,a(Math.max(i,r+.001),0,1)-r);return a((e-r)/l,0,1)}(G,t)),W=Math.pow(V,a(t.depthSizeCurve,.25,8)),z=a(l(g,d,W),d,g),K=a(z*x,I,y),[j,Q,$]=o(e,w,D),ea=Math.max(6,Math.min(48,Math.round((f<2?1:.82)*C-4.5*V+(2*b()-1)*1.4))),ei=a((1-N)*(1.15-.35*V)*K,.35,.8*B),el=w,en=D,es=k,eo=ea>=8,eh=j/255,eu=Q/255,ef=$/255;for(let t=0;t<ea&&J<Y;t++){let r=ea<=1?0:t/(ea-1),s=a(n(0,.18,r)*(1-n(.78,1,r)),0,1),u=Math.pow(s,.75),f=.65+.55*u,c=.78+.42*u,m=a(.1+.95*Math.pow(s,.9),.02,1);if(eo&&t>0){let[t,r,a]=o(e,el,en),i=.1+.12*s;eh=l(eh,t/255,i),eu=l(eu,r/255,i),ef=l(ef,a/255,i)}let E=a(a(z*f,1,512),d,g),x=a(a(K*c,1,512),I,y),T=v?a(E/Math.max(.001,g),0,1):0,M=l(.15,1,T),R=l(.65,.3,T),w=l(1,.05,T);Z(el,en,E,x,es,v?M:eo?eh:j/255,v?R:eo?eu:Q/255,v?w:eo?ef:$/255,m);let D=(2*b()-1)*.08*K*(1-s);el=i(el+Math.cos(es)*ei-Math.sin(es)*D,p-1),en=i(en+Math.sin(es)*ei+Math.cos(es)*D,_-1);let U=el/p*(A.w-1),P=en/_*(A.h-1),F=Math.floor(U),B=Math.floor(P),L=h(A.lum,A.w,A.h,F,B);es=.75*es+.25*(Math.atan2(L.gy,L.gx)+.5*Math.PI)}if(!(J>=Y)&&M&&f>=q.length-2&&J<Y){let e=a((V-.35)/.65,0,1);if(b()<e){let e=.25*B;Z(i(w+(2*b()-1)*e,p-1),i(D+(2*b()-1)*e,_-1),a(a(.88*z,1,512),d,g),a(a(.9*K,1,512),I,y),k,j/255,Q/255,$/255,.82)}}}if(T.bindBuffer(T.ARRAY_BUFFER,this.instanceCenter),T.bufferData(T.ARRAY_BUFFER,K.subarray(0,2*J),T.DYNAMIC_DRAW),T.bindBuffer(T.ARRAY_BUFFER,this.instanceSize),T.bufferData(T.ARRAY_BUFFER,j.subarray(0,2*J),T.DYNAMIC_DRAW),T.bindBuffer(T.ARRAY_BUFFER,this.instanceAngle),T.bufferData(T.ARRAY_BUFFER,Q.subarray(0,J),T.DYNAMIC_DRAW),T.bindBuffer(T.ARRAY_BUFFER,this.instanceColor),T.bufferData(T.ARRAY_BUFFER,$.subarray(0,4*J),T.DYNAMIC_DRAW),w){let e=t.opacity*(.9+.1*(f/Math.max(1,q.length-1)));T.uniform1f(w,a(e,0,1))}T.drawArraysInstanced(T.TRIANGLE_STRIP,0,4,J),null==r||null==(m=r.onProgress)||m.call(r,(f+1)/q.length)}let X=new Uint8ClampedArray(p*_*4);T.readPixels(0,0,p,_,T.RGBA,T.UNSIGNED_BYTE,X);let G=new Uint8ClampedArray(X.length),k=4*p;for(let e=0;e<_;e++){let t=e*k,r=(_-1-e)*k;G.set(X.subarray(t,t+k),r)}return T.bindVertexArray(null),T.bindFramebuffer(T.FRAMEBUFFER,null),new ImageData(G,p,_)}destroy(){let e=this.gl;if(this.program){try{e.deleteProgram(this.program)}catch(e){}this.program=null}if(this.blitProgram){try{e.deleteProgram(this.blitProgram)}catch(e){}this.blitProgram=null}if(this.vao){try{e.deleteVertexArray(this.vao)}catch(e){}this.vao=null}if(this.blitVao){try{e.deleteVertexArray(this.blitVao)}catch(e){}this.blitVao=null}for(let t of[this.quadBuffer,this.instanceCenter,this.instanceSize,this.instanceAngle,this.instanceColor])if(t)try{e.deleteBuffer(t)}catch(e){}if(this.quadBuffer=null,this.instanceCenter=null,this.instanceSize=null,this.instanceAngle=null,this.instanceColor=null,this.framebuffer){try{e.deleteFramebuffer(this.framebuffer)}catch(e){}this.framebuffer=null}if(this.colorTex){try{e.deleteTexture(this.colorTex)}catch(e){}this.colorTex=null}if(this.targetTex){try{e.deleteTexture(this.targetTex)}catch(e){}this.targetTex=null}for(let t of this.brushTextures)try{e.deleteTexture(t)}catch(e){}this.brushTextures=[],this.brushDecodeModes=[],this.brushLoadPromise=null}constructor(e){this.program=null,this.blitProgram=null,this.vao=null,this.blitVao=null,this.quadBuffer=null,this.instanceCenter=null,this.instanceSize=null,this.instanceAngle=null,this.instanceColor=null,this.framebuffer=null,this.colorTex=null,this.targetTex=null,this.brushTextures=[],this.brushDecodeModes=[],this.brushLoadPromise=null,this.rtW=0,this.rtH=0,this.canvas=e;let t=e.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"});if(!t)throw Error("WebGL2 required");this.gl=t,this.init()}}function f(e){try{return new URL(e),e}catch(e){}let t=globalThis.__GPU_ASSET_BASE_URL;try{if(t)return new URL(e,t).toString()}catch(e){}let r=globalThis.location;try{if(null==r?void 0:r.href)return new URL(e,r.href).toString()}catch(e){}return e}let c=e=>Math.max(0,Math.min(1,e));function g(e){let t=1/0,r=-1/0;for(let a=0;a<e.length;a++){let i=e[a];i<t&&(t=i),i>r&&(r=i)}let a=Math.max(1e-9,r-t);for(let r=0;r<e.length;r++)e[r]=(e[r]-t)/a}function d(e,t,r,a,i,l){let n=Math.max(0,Math.floor(a));if(0===n)return void l.set(e);for(let a=0;a<r;a++){let r=a*t,l=0,s=Math.min(t-1,n);for(let t=0;t<=s;t++)l+=e[r+t];i[r+0]=l/(s+1);for(let a=1;a<t;a++){let s=a-n-1,o=a+n;s>=0&&(l-=e[r+s]),o<=t-1&&(l+=e[r+o]);let h=Math.max(0,a-n),u=Math.min(t-1,a+n)-h+1;i[r+a]=l/u}}for(let e=0;e<t;e++){let a=0,s=Math.min(r-1,n);for(let r=0;r<=s;r++)a+=i[r*t+e];l[0*t+e]=a/(s+1);for(let s=1;s<r;s++){let o=s-n-1,h=s+n;o>=0&&(a-=i[o*t+e]),h<=r-1&&(a+=i[h*t+e]);let u=Math.max(0,s-n),f=Math.min(r-1,s+n)-u+1;l[s*t+e]=a/f}}}function m(e,t,r,a,i,l){let n=r*a,s=Math.max(0,Math.floor(i)),o=Math.max(1e-7,Number(l)||0),h=new Float32Array(n),u=new Float32Array(n),f=new Float32Array(n),c=new Float32Array(n);d(e,r,a,s,h,f),d(t,r,a,s,h,c);let g=new Float32Array(n),m=new Float32Array(n);for(let r=0;r<n;r++){let a=e[r];g[r]=a*a,m[r]=a*t[r]}let E=new Float32Array(n),x=new Float32Array(n);d(g,r,a,s,h,E),d(m,r,a,s,h,x);let T=new Float32Array(n),p=new Float32Array(n);for(let e=0;e<n;e++){let t=E[e]-f[e]*f[e],r=(x[e]-f[e]*c[e])/(t+o);T[e]=r,p[e]=c[e]-r*f[e]}let _=new Float32Array(n),b=new Float32Array(n);d(T,r,a,s,h,_),d(p,r,a,s,u,b);let A=new Float32Array(n);for(let t=0;t<n;t++){let r=_[t]*e[t]+b[t];A[t]=r<0?0:r>1?1:r}return A}{var E;let e=globalThis;e.__GPU_ASSET_BASE_URL=null!=(E=e.__GPU_ASSET_BASE_URL)?E:void 0}let x=null,T=null,p=null,_=null,b=null,A=null,M=null,R=null,v=null,y=null,w=null,D=Promise.resolve();function U(e){return new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}function P(){if(v)try{v.destroy()}catch(e){}v=null,R=null}function F(){if(w)try{w.destroy()}catch(e){}w=null,y=null}function I(e,t,r,a,i){let l=Math.max(0,Math.min(e.width,Math.floor(t))),n=Math.max(0,Math.min(e.height,Math.floor(r))),s=Math.max(1,Math.min(e.width-l,Math.floor(a))),o=Math.max(1,Math.min(e.height-n,Math.floor(i))),h=new ImageData(s,o),u=4*s;for(let t=0;t<o;t++){let r=((n+t)*e.width+l)*4,a=t*s*4;h.data.set(e.data.subarray(r,r+u),a)}return h}function B(e,t,r){let a=Math.max(1,Math.floor(t)),i=Math.max(1,Math.floor(r));if(a===e.width&&i===e.height)return U(e);let l=new OffscreenCanvas(e.width,e.height),n=l.getContext("2d",{willReadFrequently:!0});if(!n)throw Error("2D context unavailable");n.putImageData(e,0,0);let s=new OffscreenCanvas(a,i).getContext("2d",{willReadFrequently:!0});if(!s)throw Error("2D context unavailable");s.imageSmoothingEnabled=!0;try{s.imageSmoothingQuality="high"}catch(e){}return s.drawImage(l,0,0,a,i),s.getImageData(0,0,a,i)}async function L(e){let t=D.catch(()=>void 0).then(e);return D=t.then(()=>void 0,()=>void 0),t}function S(e){let t=e instanceof Error?e.message:String(e);return/webgl|context\s*lost|shader|framebuffer|texture|draw|gpu/i.test(t)}async function C(e,t){let r=!1,a=Date.now(),i=Date.now();try{var l,n;try{x&&x.abort()}catch(e){}let s=new AbortController;x=s,T=t.requestId;let o=Math.max(.0625,Number(null!=(n=null==(l=t.options)?void 0:l.scale)?n:1)),{imageData:h}=await L(async()=>{var r;let a=Math.max(1,Math.floor(e.width*o)),i=Math.max(1,Math.floor(e.height*o)),l=1!==o?B(e,a,i):U(e),n=t.depthMapData?1!==o?B(t.depthMapData,a,i):U(t.depthMapData):void 0,h=null==(r=t.options)?void 0:r.partition,f=h?I(l,h.x,h.y,h.w,h.h):l,c=n?h?I(n,h.x,h.y,h.w,h.h):n:void 0,g=(y||(y=new OffscreenCanvas(1,1)),w||(w=new u(y)),w);return{imageData:await g.render(f,t.params,{onProgress:e=>{self.postMessage({type:"progress",requestId:t.requestId,progress:Math.max(0,Math.min(1,e))})}},s.signal,c)}});if(s.signal.aborted||T!==t.requestId)throw r=!0,Error("Operation cancelled");let f=Date.now(),c={requestId:t.requestId,startedAt:i,finishedAt:f,durationMs:f-i,mode:"paint",worker:{canceled:r,overallMs:Date.now()-a}};return{imageData:h,report:c}}catch(e){throw S(e)&&(P(),F()),e}finally{T===t.requestId&&(x=null,T=null)}}self.onmessage=async e=>{let r=e.data;switch(r.type){case"init":try{r.assetBaseUrl&&"string"==typeof r.assetBaseUrl&&(globalThis.__GPU_ASSET_BASE_URL=r.assetBaseUrl)}catch(e){}r.requestId&&self.postMessage({type:"ready",requestId:r.requestId,stage:"source"});break;case"prepareSource":try{p=r.imageData,_=null,b=null,A=null,M=null,self.postMessage({type:"ready",requestId:r.requestId,stage:"source"})}catch(e){self.postMessage({type:"error",requestId:r.requestId,error:e instanceof Error?e.message:String(e)})}break;case"preprocess":try{if(!p)throw Error("No source image prepared");if(_===r.preprocessKey&&b){self.postMessage({type:"ready",requestId:r.requestId,stage:"preprocess"});break}if(A=null,M=null,!r.options.enabled){b=U(p),_=r.preprocessKey,self.postMessage({type:"ready",requestId:r.requestId,stage:"preprocess"});break}b=await L(async()=>(!R&&(R=new OffscreenCanvas(1,1)),!v&&(v=new t(R)),v).applyPreprocess(p,r.options)),_=r.preprocessKey,self.postMessage({type:"ready",requestId:r.requestId,stage:"preprocess"})}catch(e){S(e)&&P(),self.postMessage({type:"error",requestId:r.requestId,error:e instanceof Error?e.message:String(e)})}break;case"computeDepthMap":try{if(!p)throw Error("No source image prepared");if(!b)throw Error("No preprocessed image prepared");if(A===r.depthKey&&M){self.postMessage({type:"ready",requestId:r.requestId,stage:"depth"});break}M=function(e,t){let r=e.width,a=e.height,i=function(e){let t=new Float32Array(e.width*e.height),r=e.data;for(let e=0,a=0;e<r.length;e+=4,a++)t[a]=(.299*r[e]+.587*r[e+1]+.114*r[e+2])/255;return t}(e),l=function(e,t,r){let a=new Float32Array(t*r);for(let i=1;i<r-1;i++){let r=(i-1)*t,l=i*t,n=(i+1)*t;for(let i=1;i<t-1;i++){let t=e[r+(i-1)],s=e[r+i],o=e[r+(i+1)],h=e[l+(i-1)],u=(e[l+i],e[l+(i+1)]),f=e[n+(i-1)],c=e[n+i],g=e[n+(i+1)],d=3*t+-3*o+10*h+-10*u+3*f+-3*g,m=3*t+10*s+3*o+-3*f+-10*c+-3*g;a[l+i]=Math.hypot(d,m)}}return a}(i,r,a);g(l);let n=Math.max(0,Math.floor(t.densityRadius)),s=Math.max(1e-7,t.densityEps),o=n>0?m(i,l,r,a,n,s):l;o!==l&&g(o);let h=Math.max(1,Math.floor(t.guidedRadius)),u=m(i,o,r,a,h,Math.max(1e-7,t.guidedEps)),f=Math.max(0,t.centerWeight),d=c(t.highlightThreshold),E=Math.max(1,t.highlightPower),x=Math.max(1e-6,t.gamma),T=f>0?function(e,t){let r=new Float32Array(e*t),a=(e-1)/2,i=(t-1)/2,l=.35*e,n=.35*t,s=1/(2*l*l),o=1/(2*n*n),h=1/0,u=-1/0;for(let l=0;l<t;l++)for(let t=0;t<e;t++){let n=t-a,f=l-i,c=Math.exp(-(n*n)*s-f*f*o);r[l*e+t]=c,c<h&&(h=c),c>u&&(u=c)}let f=Math.max(1e-9,u-h);for(let e=0;e<r.length;e++)r[e]=(r[e]-h)/f;return r}(r,a):null,p=new Float32Array(r*a);for(let e=0;e<p.length;e++){let t=u[e];T&&(t*=1-f+f*T[e]),t=t<0?0:t>1?1:t,1!==x&&(t=Math.pow(t,1/x)),t=function(e,t,r){if(e<=t)return e;let a=1-Math.pow(1-(e-t)/Math.max(1e-6,1-t),r);return t+(1-t)*a}(t,d,E),p[e]=c(t)}g(p);let _=new ImageData(r,a);for(let e=0;e<p.length;e++){let t=Math.max(0,Math.min(255,Math.round(255*p[e]))),r=4*e;_.data[r]=t,_.data[r+1]=t,_.data[r+2]=t,_.data[r+3]=255}return _}(b,r.options),A=r.depthKey,self.postMessage({type:"ready",requestId:r.requestId,stage:"depth"})}catch(e){self.postMessage({type:"error",requestId:r.requestId,error:e instanceof Error?e.message:String(e)})}break;case"render":try{if(!b)throw Error("No preprocessed image prepared");let{imageData:e,report:t}=await C(U(b),r);t&&self.postMessage({type:"report",requestId:r.requestId,report:t}),self.postMessage({type:"result",requestId:r.requestId,imageData:e,report:null!=t?t:void 0},[e.data.buffer])}catch(t){let e=t instanceof Error?t.message:String(t);self.postMessage({type:"error",requestId:r.requestId,error:e})}break;case"getPreprocessed":{if(!b){self.postMessage({type:"error",requestId:r.requestId,error:"No preprocessed image prepared"});break}let e=U(b);self.postMessage({type:"result",requestId:r.requestId,imageData:e},[e.data.buffer]);break}case"getDepthMap":{if(!M){self.postMessage({type:"error",requestId:r.requestId,error:"No depth map prepared"});break}let e=U(M);self.postMessage({type:"result",requestId:r.requestId,imageData:e},[e.data.buffer]);break}case"renderDirect":try{let{imageData:e,report:t}=await C(r.imageData,r);t&&self.postMessage({type:"report",requestId:r.requestId,report:t}),self.postMessage({type:"result",requestId:r.requestId,imageData:e,report:null!=t?t:void 0},[e.data.buffer])}catch(e){self.postMessage({type:"error",requestId:r.requestId,error:e instanceof Error?e.message:String(e)})}break;case"cancel":if(x)try{x.abort()}catch(e){}break;case"dispose":try{x&&x.abort()}catch(e){}x=null,T=null,p=null,_=null,b=null,A=null,M=null,P(),F(),self.close()}}}}]);