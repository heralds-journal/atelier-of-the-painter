(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5697:(e,t,a)=>{Promise.resolve().then(a.bind(a,8337))},8337:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>ei});var i=a(5155),r=a(2115),s=a(5239),l=a(3101),n=a(2467),o=a(2821),d=a(5889);function p(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,d.QP)((0,o.$)(t))}let c=(0,l.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",xs:"h-6 gap-1 rounded-md px-2 text-xs has-[>svg]:px-1.5 [&_svg:not([class*='size-'])]:size-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9","icon-xs":"size-6 rounded-md [&_svg:not([class*='size-'])]:size-3","icon-sm":"size-8","icon-lg":"size-10"}},defaultVariants:{variant:"default",size:"default"}});function u(e){let{className:t,variant:a="default",size:r="default",asChild:s=!1,...l}=e,o=s?n.bL:"button";return(0,i.jsx)(o,{"data-slot":"button","data-variant":a,"data-size":r,className:p(c({variant:a,size:r,className:t})),...l})}var h=a(5917),m=a(8162);function x(e){let{className:t,...a}=e;return(0,i.jsx)(m.Root,{"data-slot":"checkbox",className:p("peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",t),...a,children:(0,i.jsx)(m.Indicator,{"data-slot":"checkbox-indicator",className:"grid place-content-center text-current transition-none",children:(0,i.jsx)(h.A,{className:"size-3.5"})})})}var g=a(7259);function f(e){let{...t}=e;return(0,i.jsx)(g.Root,{"data-slot":"collapsible",...t})}function y(e){let{...t}=e;return(0,i.jsx)(g.CollapsibleTrigger,{"data-slot":"collapsible-trigger",...t})}function v(e){let{...t}=e;return(0,i.jsx)(g.CollapsibleContent,{"data-slot":"collapsible-content",...t})}function b(e){let{className:t,type:a,...r}=e;return(0,i.jsx)("input",{type:a,"data-slot":"input",className:p("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",t),...r})}var w=a(489);function S(e){let{className:t,...a}=e;return(0,i.jsx)(w.Root,{"data-slot":"label",className:p("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...a})}var M=a(3026);function j(e){let{className:t,defaultValue:a,value:s,min:l=0,max:n=100,...o}=e,d=r.useMemo(()=>Array.isArray(s)?s:Array.isArray(a)?a:[l],[s,a,l]);return(0,i.jsxs)(M.Root,{"data-slot":"slider",defaultValue:a,value:s,min:l,max:n,className:p("relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col",t),...o,children:[(0,i.jsx)(M.Track,{"data-slot":"slider-track",className:p("bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-1.5 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5"),children:(0,i.jsx)(M.Range,{"data-slot":"slider-range",className:p("bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full")})}),Array.from({length:d.length},(e,t)=>(0,i.jsx)(M.Thumb,{"data-slot":"slider-thumb",className:"border-primary ring-ring/50 bg-background block size-4 shrink-0 rounded-full border shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"},t))]})}function k(e){return Array.isArray(e.value)}function C(e){return!Array.isArray(e.value)}function N(e){let{label:t,min:a,max:s,step:l=1,inputWidthPx:n=72,disabled:o,subtitle:d,allowOutOfRange:p=!1}=e,c=(0,r.useId)(),h=k(e),[m,x]=(0,r.useState)(String(Array.isArray(e.value)?e.value[0]:e.value)),[g,f]=(0,r.useState)(String(Array.isArray(e.value)?e.value[1]:e.value)),y=(0,r.useRef)(null),v=(0,r.useRef)(null);(0,r.useEffect)(()=>{document.activeElement!==y.current&&document.activeElement!==v.current&&(Array.isArray(e.value)?(x(String(e.value[0])),f(String(e.value[1]))):(x(String(e.value)),f(String(e.value))))},[e.value]);let w=e=>Math.max(a,Math.min(s,e)),M=()=>{if(!k(e))return;let t=parseFloat(m),a=parseFloat(g);if(isNaN(t)||isNaN(a)){x(String(e.value[0])),f(String(e.value[1]));return}let i=p?t:w(t),r=p?a:w(a),s=i<=r?[i,r]:[r,i];(s[0]!==e.value[0]||s[1]!==e.value[1])&&e.onChange(s),x(String(s[0])),f(String(s[1]))};return(0,i.jsxs)("div",{className:"group space-y-1 "+(o?"opacity-60":""),"data-disabled":o?"true":"false","aria-disabled":o,children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)(S,{htmlFor:c,className:"text-xs",children:t}),h?(0,i.jsxs)("div",{className:"flex items-center gap-1",children:[(0,i.jsx)(b,{id:c,type:"number",className:"h-6 px-2 text-xs",style:{width:n},ref:y,value:m,min:p?void 0:a,max:p?void 0:s,step:l,onChange:e=>x(e.target.value),onBlur:M,onKeyDown:t=>{"Enter"===t.key&&t.currentTarget.blur(),"Escape"===t.key&&(Array.isArray(e.value)&&(x(String(e.value[0])),f(String(e.value[1]))),t.currentTarget.blur())},disabled:o,"aria-label":"".concat(t," from")}),(0,i.jsx)("span",{className:"text-xs text-muted-foreground",children:"→"}),(0,i.jsx)(b,{type:"number",className:"h-6 px-2 text-xs",style:{width:n},ref:v,value:g,min:p?void 0:a,max:p?void 0:s,step:l,onChange:e=>f(e.target.value),onBlur:M,onKeyDown:t=>{"Enter"===t.key&&t.currentTarget.blur(),"Escape"===t.key&&(Array.isArray(e.value)&&(x(String(e.value[0])),f(String(e.value[1]))),t.currentTarget.blur())},disabled:o,"aria-label":"".concat(t," to")})]}):(0,i.jsxs)("div",{className:"flex items-center gap-1",children:[(0,i.jsx)(u,{type:"button",variant:"outline",size:"icon-xs",className:"text-xs",onClick:()=>{let t=Array.isArray(e.value)?e.value[0]:e.value,a=p?t-l:w(t-l);C(e)&&e.onChange(a),x(String(a))},disabled:o,"aria-label":"Decrement ".concat(t),children:"−"}),(0,i.jsx)(b,{id:c,type:"number",className:"h-6 px-2 text-xs",style:{width:n},ref:y,value:m,min:p?void 0:a,max:p?void 0:s,step:l,onChange:e=>x(e.target.value),onBlur:()=>{let t=parseFloat(m),a=Array.isArray(e.value)?e.value[0]:e.value;if(isNaN(t))return void x(String(a));let i=p?t:w(t);i!==a&&C(e)&&e.onChange(i),x(String(i))},onKeyDown:t=>{"Enter"===t.key&&t.currentTarget.blur(),"Escape"===t.key&&(x(String(Array.isArray(e.value)?e.value[0]:e.value)),t.currentTarget.blur())},disabled:o,"aria-label":"".concat(t," value")}),(0,i.jsx)(u,{type:"button",variant:"outline",size:"icon-xs",className:"text-xs",onClick:()=>{let t=Array.isArray(e.value)?e.value[0]:e.value,a=p?t+l:w(t+l);C(e)&&e.onChange(a),x(String(a))},disabled:o,"aria-label":"Increment ".concat(t),children:"+"})]})]}),d&&(0,i.jsx)("div",{className:"text-[10px] leading-4 text-muted-foreground whitespace-pre-line",children:d}),(0,i.jsx)(j,{value:(()=>{if(Array.isArray(e.value)){let t=w(e.value[0]),a=w(e.value[1]);return t<=a?[t,a]:[a,t]}return[w(e.value)]})(),min:a,max:s,step:l,disabled:o,"aria-label":t,onValueChange:t=>{var a,i,r;if(k(e)){let r=null!=(a=t[0])?a:e.value[0],s=null!=(i=t[1])?i:e.value[1],l=w(r),n=w(s),o=l<=n?[l,n]:[n,l];e.onChange(o),x(String(o[0])),f(String(o[1]))}else{let a=w(null!=(r=t[0])?r:e.value);e.onChange(a),x(String(a))}}})]})}function P(e){let t="/atelier-of-the-painter".replace(/\/$/,"");if(!e)return t||"/";let a=e.startsWith("/")?e:"/".concat(e);return"".concat(t).concat(a)||a}let R=[{name:"Sample 1",src:P("/gw669.jpg"),presetIdx:0},{name:"Sample 2",src:P("/gw063.jpg"),presetIdx:0},{name:"Sample 3",src:P("/gw103.jpg"),presetIdx:0},{name:"Sample 4",src:P("/gw435.jpg"),presetIdx:0},{name:"Sample 5",src:P("/gw226.jpg"),presetIdx:0},{name:"Sample 6",src:P("/gw754.jpg"),presetIdx:0},{name:"Sample 10",src:P("/gw425.jpg"),presetIdx:0},{name:"Sample 12",src:P("/gw495.jpg"),presetIdx:0}],z={baseline:{defaults:{minShortSide:1536,maxShortSide:1536},limits:{minShortSide:{min:256,max:4096,step:64},maxShortSide:{min:256,max:4096,step:64}}},preprocess:{defaults:{enabled:!0,blurEnabled:!0,blurRadius:80,blurAmount:.65,saturation:1.05,brightness:1,warmth:0,tint:0},limits:{blurRadius:{min:0,max:160,step:1},blurAmount:{min:0,max:1,step:.05},saturation:{min:0,max:2,step:.05},brightness:{min:0,max:2,step:.05},warmth:{min:-1,max:1,step:.05},tint:{min:-1,max:1,step:.05}}},depthMap:{defaults:{densityRadius:14,densityEps:.02,guidedRadius:40,guidedEps:.007,centerWeight:0,highlightPower:4.8,highlightThreshold:.18,gamma:1.55},limits:{densityRadius:{min:0,max:80,step:1},densityEps:{min:5e-4,max:.08,step:5e-4},guidedRadius:{min:1,max:100,step:1},guidedEps:{min:5e-4,max:.05,step:5e-4},centerWeight:{min:0,max:.6,step:.01},highlightPower:{min:1,max:12,step:.1},highlightThreshold:{min:0,max:.98,step:.01},gamma:{min:.5,max:3,step:.05}}},paint:{defaults:{baseBrushPx:156,minBrushPx:24,layers:6,opacity:.24,depthSizeStart:.2,depthSizeEnd:1,depthSizeCurve:1.35,jitter:.6,density:1,strokeLength:18,strokeOverlap:.92,seed:1337,debugMask:!1},limits:{baseBrushPx:{min:4,max:72,step:1},minBrushPx:{min:1,max:72,step:1},layers:{min:1,max:6,step:1},opacity:{min:.05,max:1,step:.01},depthSizeStart:{min:0,max:.98,step:.01},depthSizeEnd:{min:.02,max:1,step:.01},depthSizeCurve:{min:.5,max:4,step:.05},jitter:{min:0,max:1,step:.01},density:{min:.4,max:2,step:.05},strokeLength:{min:4,max:500,step:1},strokeOverlap:{min:.2,max:.92,step:.01},seed:{min:1,max:99999,step:1}}},performance:{defaults:{tileSizePx:512,parallelWorkers:!1,autoTileSize:!1,autoRenderOnEdit:!1},limits:{tileSizePx:{min:128,max:2048,step:64}}},view:{defaults:{areaSize:360},limits:{areaSize:{min:64,max:1024,step:16}}}},O=[1,.583,.354,.229,.158,.117],A=(e,t,a)=>Math.max(t,Math.min(a,e));function E(e,t){let a=Math.max(1,e.baseBrushPx),i=A(e.minBrushPx,1,a);return{maxMajor:A(a*t,1,512),minMajor:A(i*t,1,512)}}function D(e,t){let a=A(e,t.layerMinMajor,t.layerMaxMajor),i=A(.75/1.35*a,t.layerMinMinor,t.layerMaxMinor),r=A(A(.65*a,1,512),t.layerMinMajor,t.layerMaxMajor),s=A(A(1.2*a,1,512),t.layerMinMajor,t.layerMaxMajor),l=A(A(.78*i,1,512),t.layerMinMinor,t.layerMaxMinor),n=A(A(1.2*i,1,512),t.layerMinMinor,t.layerMaxMinor);return{base:{major:a,minor:i},min:{major:r,minor:l},max:{major:s,minor:n}}}class T{init(){if(this.worker)return;let e="undefined"!=typeof location&&location.origin?location.origin:void 0,t=new Worker(a.tu(new URL(a.p+a.u(63),a.b)),{type:void 0});t.postMessage({type:"init",width:1,height:1,assetBaseUrl:e}),t.onmessage=e=>{var t,a,i,r,s,l,n;let o=e.data;if(o&&o.type)switch(o.type){case"progress":{let e=this.pending.get(o.requestId);if(e&&"number"==typeof o.progress){let r=Number(o.progress)||0,s=null!=(t=e._lastProgress)?t:-1/0;(s===-1/0||r>=1&&s<1||r-s>=.01)&&(null==(i=e.events)||null==(a=i.onProgress)||a.call(i,r),e._lastProgress=Math.min(1,r))}break}case"report":{let e=this.pending.get(o.requestId);e&&o.report&&(e._reported=!0,null==(s=e.events)||null==(r=s.onReport)||r.call(s,o.report),this.lastReport=o.report);break}case"ready":{let e=this.pending.get(o.requestId);e&&(this.pending.delete(o.requestId),e.resolve(o));break}case"result":{let e=this.pending.get(o.requestId);if(e){try{o.report&&!e._reported&&(null==(n=e.events)||null==(l=n.onReport)||l.call(n,o.report),e._reported=!0),o.report&&(this.lastReport=o.report)}catch(e){}this.pending.delete(o.requestId),e.resolve(o.imageData)}break}case"error":{let e=o.requestId?this.pending.get(o.requestId):void 0;e&&(this.pending.delete(o.requestId),e.reject(Error(o.error||"Worker error")))}}},this.worker=t}ensurePool(e){if(this.poolSize===e&&this.pool.length===e)return;let t="undefined"!=typeof location&&location.origin?location.origin:void 0;for(let e of this.pool)try{e.terminate()}catch(e){}this.pool=[],this.poolSourceKeys=[],this.poolPreprocessKeys=[],this.poolSize=e;for(let i=0;i<e;i++){let e=new Worker(a.tu(new URL(a.p+a.u(444),a.b)),{type:void 0});try{e.postMessage({type:"init",width:1,height:1,assetBaseUrl:t})}catch(e){}this.pool.push(e),this.poolSourceKeys.push(null),this.poolPreprocessKeys.push(null)}}async getPreprocessedFromCoordinator(){return this.request({type:"getPreprocessed"})}async getDepthFromCoordinator(){return this.request({type:"getDepthMap"})}async renderPool(e,t,a,i,r,s,l,n){var o,d,p,c,u,h,m,x,g,f;let y=arguments.length>8&&void 0!==arguments[8]?arguments[8]:2;this.ensurePool(y);let v=this.recommendTileSize(null==n?void 0:n.tileSize),b=Math.max(.0625,Number(null!=(d=null==n?void 0:n.scale)?d:1)),w=e.width,S=e.height,M=Math.max(1,Math.floor(w*b)),j=Math.max(1,Math.floor(S*b)),k=null==n?void 0:n.partition,C=Math.max(0,Math.floor(null!=(p=null==k?void 0:k.x)?p:0)),N=Math.max(0,Math.floor(null!=(c=null==k?void 0:k.y)?c:0)),P=Math.max(1,Math.floor(null!=(u=null==k?void 0:k.w)?u:M)),R=Math.max(1,Math.floor(null!=(h=null==k?void 0:k.h)?h:j)),z=Math.max(1,Math.floor(R/y)),O=Array(y).fill(0),A=e=>t=>{var a;O[e]=Math.min(Math.max(t,0),1);let i=O.reduce((e,t)=>e+t,0)/y;null==l||null==(a=l.onProgress)||a.call(l,i)},E=[];for(let e=0;e<y;e++){let t=N+e*z,a=N+R-t,i=e===y-1?a:Math.min(z,a);if(i<=0)continue;let r={x:C,y:t,w:P,h:i};E.push({idx:e,worker:this.pool[e],rect:r})}let D=E.map(e=>e.rect),T=[],B=new Set;for(let e of E)this.poolSourceKeys[e.idx]!==t&&B.add(e.idx);let I=new Map;if(B.size>0){let t=Array.from(B.values()),a=t[t.length-1];for(let i of t)i===a?I.set(i,e):I.set(i,new ImageData(new Uint8ClampedArray(e.data),e.width,e.height))}let H=new Map;if(s){let e=null==(m=E[E.length-1])?void 0:m.idx;for(let t of E)t.idx===e?H.set(t.idx,s):H.set(t.idx,new ImageData(new Uint8ClampedArray(s.data),s.width,s.height))}for(let e of E){let s=e.idx,l=e.worker,n=e.rect,o=(async()=>{if(B.has(s)){let e=I.get(s);if(!e)throw Error("Missing pooled source payload");await this.requestPool(l,{type:"prepareSource",sourceKey:t,imageData:e}),this.poolSourceKeys[s]=t,this.poolPreprocessKeys[s]=null}this.poolPreprocessKeys[s]!==a&&(await this.requestPool(l,{type:"preprocess",preprocessKey:a,options:i}),this.poolPreprocessKeys[s]=a);let e=H.get(s),o=await this.requestPool(l,{type:"render",params:r,depthMapData:e,options:{scale:b,tileSize:v,partition:n}},void 0,A(s)),d=o.report;d&&(this.lastReport=d);let p=(null==d?void 0:d.startedAt)||Date.now(),c=(null==d?void 0:d.finishedAt)||Date.now();return{idx:s,data:o.imageData,report:d,startedAt:p,finishedAt:c}})();T.push(o)}let W=performance.now?performance.now():Date.now(),K=await Promise.all(T),F=new ImageData(P,R);for(let e of K){let t=D[e.idx].y-N;for(let a=0;a<e.data.height;a++){let i=a*e.data.width*4,r=(t+a)*P*4;F.data.set(e.data.data.subarray(i,i+4*e.data.width),r)}}let q=(performance.now?performance.now():Date.now())-W;null==l||null==(o=l.onProgress)||o.call(l,1);try{let e=(null==(x=K[K.length-1])?void 0:x.report)||(null==(g=K.find(e=>e.report))?void 0:g.report);if(e){let t=K.map((e,t)=>({index:t,rect:D[t],durationMs:Math.max(0,e.finishedAt-e.startedAt)})),a={...e,parallel:{enabled:!0,poolSize:y,mergeMs:q,bands:t}};this.lastReport=a,null==l||null==(f=l.onReport)||f.call(l,a)}}catch(e){}return F}async request(e,t,a){if(this.init(),!this.worker)throw Error("Worker not available");let i=Math.random().toString(36).slice(2),r=new Promise((e,t)=>{this.pending.set(i,{resolve:t=>e(t),reject:t,events:a})});return this.worker.postMessage({...e,requestId:i},null!=t?t:[]),r}async requestPool(e,t,a,i){let r=Math.random().toString(36).slice(2);return new Promise((s,l)=>{let n=t=>{let a=t.data;if(a&&a.type&&a.requestId===r){if("progress"===a.type){var o;null==i||i(Math.max(0,Math.min(1,Number(null!=(o=a.progress)?o:0))));return}if("error"===a.type){e.removeEventListener("message",n),l(Error(a.error||"Worker error"));return}if("ready"===a.type){e.removeEventListener("message",n),s(a);return}if("result"===a.type){e.removeEventListener("message",n),s({imageData:a.imageData,report:a.report});return}}};e.addEventListener("message",n),e.postMessage({...t,requestId:r},null!=a?a:[])})}recommendTileSize(e){var t,a;return"number"==typeof e&&e>0?e:((null==(a=this.lastReport)||null==(t=a.limits)?void 0:t.MAX_TEXTURE_SIZE)||0)>=8192?768:512}async render(e,t,a,i,r,s,l,n){if(this.init(),!this.worker)throw Error("Worker not available");let o=!!(null==n?void 0:n.parallel);if(this.sourceKey!==t){let a=o?new ImageData(new Uint8ClampedArray(e.data),e.width,e.height):e;await this.request({type:"prepareSource",sourceKey:t,imageData:a},[a.data.buffer]),this.sourceKey=t,this.preprocessKey=null}this.preprocessKey!==a&&(await this.request({type:"preprocess",preprocessKey:a,options:r}),this.preprocessKey=a);let d=this.recommendTileSize(null==n?void 0:n.tileSize);if(o){var p;return this.renderPool(e,t,a,r,i,s,l,{scale:null==n?void 0:n.scale,partition:null==n?void 0:n.partition,tileSize:d},Math.max(2,Math.floor(null!=(p=n.poolSize)?p:2)))}return this.request({type:"render",params:i,depthMapData:s,options:{scale:null==n?void 0:n.scale,partition:null==n?void 0:n.partition,tileSize:d}},void 0,l)}async getDepthMap(e,t,a,i,r,s){if(this.init(),!this.worker)throw Error("Worker not available");if(this.sourceKey!==t){if(!e)throw Error("Missing sourceImageData for new sourceKey");await this.request({type:"prepareSource",sourceKey:t,imageData:e},[e.data.buffer]),this.sourceKey=t,this.preprocessKey=null,this.depthKey=null}return this.preprocessKey!==a&&(await this.request({type:"preprocess",preprocessKey:a,options:i}),this.preprocessKey=a,this.depthKey=null),this.depthKey!==r&&(await this.request({type:"computeDepthMap",depthKey:r,options:s}),this.depthKey=r),this.getDepthFromCoordinator()}async getPreprocessedImage(e,t,a,i){if(this.init(),!this.worker)throw Error("Worker not available");return this.sourceKey!==t&&(await this.request({type:"prepareSource",sourceKey:t,imageData:e},[e.data.buffer]),this.sourceKey=t,this.preprocessKey=null,this.depthKey=null),this.preprocessKey!==a&&(await this.request({type:"preprocess",preprocessKey:a,options:i}),this.preprocessKey=a,this.depthKey=null),this.getPreprocessedFromCoordinator()}cancel(){var e;for(let t of(null==(e=this.worker)||e.postMessage({type:"cancel"}),this.pool))try{t.postMessage({type:"cancel"})}catch(e){}for(let[e,t]of this.pending){try{t.reject(Error("Operation cancelled"))}catch(e){}this.pending.delete(e)}}dispose(){if(this.worker){try{this.worker.postMessage({type:"dispose"})}catch(e){}this.worker.terminate()}for(let e of this.pool){try{e.postMessage({type:"dispose"})}catch(e){}try{e.terminate()}catch(e){}}this.pool=[],this.poolSourceKeys=[],this.poolPreprocessKeys=[],this.worker=null,this.sourceKey=null,this.preprocessKey=null,this.depthKey=null}constructor(){this.worker=null,this.pool=[],this.poolSize=2,this.poolSourceKeys=[],this.poolPreprocessKeys=[],this.pending=new Map,this.lastReport=null,this.sourceKey=null,this.preprocessKey=null,this.depthKey=null}}function B(e){return new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}function I(){return{uiMode:"paint",previewMode:"area",zoom:1,params:z.paint.defaults,pp:z.preprocess.defaults,depthMap:z.depthMap.defaults,ppApplied:z.preprocess.defaults,depthMapApplied:z.depthMap.defaults,minShortSide:z.baseline.defaults.minShortSide,maxShortSide:z.baseline.defaults.maxShortSide,tileSizePx:z.performance.defaults.tileSizePx,parallelWorkers:z.performance.defaults.parallelWorkers,autoTileSize:z.performance.defaults.autoTileSize,autoRenderOnEdit:z.performance.defaults.autoRenderOnEdit,areaSize:z.view.defaults.areaSize,areaCenter:null,areaCrop:null,hasRenderedOnce:!1,pendingChanges:!1,overlaySticky:!1,isPreparingBaseline:!1,baselineVersion:0,baselineHasAppliedOnce:!1,baselinePendingChanges:!1,baselineOverlaySticky:!1,showDiagnostics:!1,selectedReportIdx:-1}}function H(e,t){switch(t.type){case"PATCH":return{...e,...t.patch};case"RESET_FOR_NEW_SOURCE":var a;return{...e,uiMode:"paint",previewMode:"compare",areaCenter:null,areaCrop:null,hasRenderedOnce:!1,pendingChanges:!1,overlaySticky:!1,isPreparingBaseline:!1,baselineVersion:0,baselineHasAppliedOnce:!1,baselinePendingChanges:!1,baselineOverlaySticky:!1,selectedReportIdx:-1,...null!=(a=t.patch)?a:{}};case"RESET_FOR_REMOVE_SOURCE":return{...e,uiMode:"paint",previewMode:"compare",zoom:1,areaCenter:null,areaCrop:null,hasRenderedOnce:!1,pendingChanges:!1,overlaySticky:!1,isPreparingBaseline:!1,baselineVersion:0,baselineHasAppliedOnce:!1,baselinePendingChanges:!1,baselineOverlaySticky:!1,selectedReportIdx:-1}}}let W=(0,r.createContext)(null),K=(0,r.createContext)(null),F=(0,r.createContext)(null);function q(){let e=(0,r.useContext)(W);if(!e)throw Error("useStudioState must be used within StudioProvider");return e}function L(){let e=(0,r.useContext)(K);if(!e)throw Error("useStudioRuntime must be used within StudioProvider");return e}function _(){let e=(0,r.useContext)(F);if(!e)throw Error("useStudioActions must be used within StudioProvider");return e}function U(e){let{children:t}=e,[a,l]=(0,r.useReducer)(H,void 0,I),[n,o]=(0,r.useState)(null),[d,p]=(0,r.useState)(null),[c,u]=(0,r.useState)(null),[h,m]=(0,r.useState)(null),[x,g]=(0,r.useState)(null),[f,y]=(0,r.useState)(null),[v,b]=(0,r.useState)(null),[w,S]=(0,r.useState)(null),[M,j]=(0,r.useState)(null),[k,C]=(0,r.useState)(null),[N,P]=(0,r.useState)(null),[z,O]=(0,r.useState)(null),A=!!z,[E,D]=(0,r.useState)(null),[q,L]=(0,r.useState)(null),[_,U]=(0,r.useState)(!1),[J,V]=(0,r.useState)(!1),[G,Z]=(0,r.useState)(0),[$,Q]=(0,r.useState)(!0),[X,Y]=(0,r.useState)(null),[ee,et]=(0,r.useState)([]),ea=(0,r.useRef)(null),ei=(0,r.useRef)(0),er=(0,r.useRef)(0),es=(0,r.useRef)(null),el=(0,r.useRef)(null),en=(0,r.useRef)(null);(0,r.useEffect)(()=>(ea.current=new T,()=>{try{var e;null==(e=ea.current)||e.dispose()}catch(e){}}),[]);let eo=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{uiMode:e}})},[]),ed=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{previewMode:e}})},[]),ep=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{zoom:e}})},[]),ec=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{zoom:e(a.zoom)}})},[a.zoom]),eu=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{params:"function"==typeof e?e(a.params):e}})},[a.params]),eh=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{pp:"function"==typeof e?e(a.pp):e}})},[a.pp]),em=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{depthMap:"function"==typeof e?e(a.depthMap):e}})},[a.depthMap]),ex=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{minShortSide:e}})},[]),eg=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{maxShortSide:e}})},[]),ef=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{tileSizePx:e}})},[]),ey=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{parallelWorkers:e}})},[]),ev=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{autoTileSize:e}})},[]),eb=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{autoRenderOnEdit:e}})},[]),ew=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{areaSize:e}})},[]),eS=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{showDiagnostics:e}})},[]),eM=(0,r.useCallback)(e=>{l({type:"PATCH",patch:{selectedReportIdx:e}})},[]),ej=(0,r.useCallback)(()=>{et([]),eM(-1)},[eM]),ek=(0,r.useCallback)(()=>{var e,t,i,r;let s=a.previewMode,l="area"===s?{cx:null!=(i=null==(e=a.areaCenter)?void 0:e.x)?i:null,cy:null!=(r=null==(t=a.areaCenter)?void 0:t.y)?r:null,size:a.areaSize}:null;return{img:null!=n?n:null,mode:s,params:a.params,pp:a.ppApplied,depth:a.depthMapApplied,baselineVersion:a.baselineVersion,minShortSide:a.minShortSide,maxShortSide:a.maxShortSide,area:l,perf:{tileSizePx:a.tileSizePx,parallelWorkers:a.parallelWorkers,autoTileSize:a.autoTileSize}}},[n,a.areaCenter,a.areaSize,a.autoTileSize,a.baselineVersion,a.depthMapApplied,a.maxShortSide,a.minShortSide,a.params,a.parallelWorkers,a.ppApplied,a.previewMode,a.tileSizePx]),eC=(0,r.useCallback)((e,t)=>{try{var i;null==(i=ea.current)||i.cancel()}catch(e){}(null==t?void 0:t.preserveOriginal)||p(e),m(null),g(null),b(null),y(null),j(null),C(null),P(null),O(null),l({type:"RESET_FOR_NEW_SOURCE"}),l({type:"PATCH",patch:{ppApplied:a.pp,depthMapApplied:a.depthMap}}),D(null),L(null),U(!1),V(!1),Z(0),Y(null),et([]),eM(-1),Q(!0),S(null),es.current=null;let r=new Image;r.crossOrigin="anonymous",r.onload=()=>{let t=r.naturalWidth,i=r.naturalHeight,s=Math.min(t,i),n=e;if(a.maxShortSide>0&&s>a.maxShortSide){let e=Math.max(1e-4,a.maxShortSide/s),l=Math.max(1,Math.floor(t*e)),o=Math.max(1,Math.floor(i*e)),d=document.createElement("canvas");d.width=l,d.height=o;let p=d.getContext("2d",{willReadFrequently:!0});if(p){try{p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high"}catch(e){}p.drawImage(r,0,0,l,o);try{n=d.toDataURL("image/png")}catch(e){try{n=d.toDataURL("image/jpeg",.95)}catch(e){}}}}o(n);let d=new Image;d.crossOrigin="anonymous",d.onload=()=>{let e=d.naturalWidth,r=d.naturalHeight;try{S({origW:t,origH:i,workW:e,workH:r})}catch(e){}let s=Math.min(e,r),n=Math.max(8,Math.min(Math.floor(a.areaSize),s)),o=Math.floor(n/2),p=Math.floor(e/2),c=Math.floor(r/2),u=Math.max(0,Math.min(p-o,e-n)),h=Math.max(0,Math.min(c-o,r-n));l({type:"PATCH",patch:{areaCenter:{x:p,y:c},areaCrop:{left:u,top:h,size:n}}}),j(null),C(null),m(d)},d.src=n},r.src=e},[eM,a.areaSize,a.depthMap,a.maxShortSide,a.pp]),eN=(0,r.useCallback)(e=>{let t=R[e];t&&(u(t.name),eC(t.src))},[eC]),eP=(0,r.useCallback)(e=>{u(e.name);let t=new FileReader;t.onload=()=>eC(String(t.result)),t.readAsDataURL(e)},[eC]),eR=(0,r.useCallback)(()=>{try{var e;null==(e=ea.current)||e.cancel()}catch(e){}u(null),o(null),p(null),m(null),g(null),b(null),y(null),j(null),C(null),l({type:"RESET_FOR_REMOVE_SOURCE"}),P(null),O(null),D(null),L(null),U(!1),V(!1),Z(0),S(null),es.current=null},[]);(0,r.useEffect)(()=>{h&&g(function(e){let t=document.createElement("canvas");t.width=e.naturalWidth,t.height=e.naturalHeight;let a=t.getContext("2d",{willReadFrequently:!0});if(!a)throw Error("2D context");return a.drawImage(e,0,0),a.getImageData(0,0,t.width,t.height)}(h))},[h]),(0,r.useEffect)(()=>{d&&eC(d,{preserveOriginal:!0})},[a.maxShortSide]);let ez=(0,r.useCallback)(async()=>{if(x&&ea.current){l({type:"PATCH",patch:{isPreparingBaseline:!0}});try{try{ea.current.cancel()}catch(e){}let e=B(x),t=JSON.stringify({img:n,w:e.width,h:e.height,maxShortSide:a.maxShortSide}),i=JSON.stringify({sourceStageKey:t,pp:a.pp}),r=JSON.stringify({preprocessStageKey:i,depthMap:a.depthMap}),s=await ea.current.getPreprocessedImage(e,t,i,a.pp),o=await ea.current.getDepthMap(null,t,i,a.pp,r,a.depthMap);P(B(s)),O(B(o)),l({type:"PATCH",patch:{ppApplied:a.pp,depthMapApplied:a.depthMap,baselineVersion:a.baselineVersion+1,hasRenderedOnce:!1,pendingChanges:!1,overlaySticky:!1,baselineHasAppliedOnce:!0,baselinePendingChanges:!1,baselineOverlaySticky:!1}}),es.current=null,D(B(s)),L(B(o))}catch(e){"Operation cancelled"!==((null==e?void 0:e.message)||String(e))&&console.error(e)}finally{l({type:"PATCH",patch:{isPreparingBaseline:!1}})}}},[n,x,a.baselineVersion,a.depthMap,a.maxShortSide,a.pp]),eO=(0,r.useCallback)(async()=>{if(!ea.current||!x||a.isPreparingBaseline)return;let e=++er.current;try{ea.current.cancel()}catch(e){}let t=JSON.stringify({img:n,w:x.width,h:x.height,maxShortSide:a.maxShortSide}),i=JSON.stringify({sourceStageKey:t,pp:a.pp}),r=JSON.stringify({preprocessStageKey:i,depthMap:a.depthMap});U(!0);try{let s=await ea.current.getPreprocessedImage(B(x),t,i,a.pp),l=await ea.current.getDepthMap(null,t,i,a.pp,r,a.depthMap);if(er.current!==e)return;D(s),L(l)}catch(t){let e=(null==t?void 0:t.message)||String(t);if("Operation cancelled"!==e&&(console.error(t),/webgl|context lost|webgl2|exhausted|limits unavailable|failed to create webgl/i.test(e))){Q(!1);try{var s;null==(s=ea.current)||s.dispose()}catch(e){}}}finally{er.current===e&&U(!1)}},[n,x,a.depthMap,a.isPreparingBaseline,a.maxShortSide,a.pp]),eA=(0,r.useCallback)(async()=>{var e,t;if(!ea.current||!x||!A)return;let i=++ei.current;try{ea.current.cancel()}catch(e){}let r=JSON.stringify({img:n,w:x.width,h:x.height,maxShortSide:a.maxShortSide}),s=JSON.stringify({sourceStageKey:r,pp:a.ppApplied});V(!0),Z(1);try{if("compare"===a.previewMode){let e=Math.min(x.width,x.height),t=1;t=e<a.minShortSide?Math.max(1,Math.ceil(a.minShortSide/Math.max(1,e))):a.maxShortSide>0&&e>a.maxShortSide?Math.max(.0625,a.maxShortSide/Math.max(1,e)):1,ei.current===i&&b(x);let n=a.autoTileSize?void 0:a.tileSizePx,o={scale:t,parallel:a.parallelWorkers,poolSize:2,..."number"==typeof n?{tileSize:n}:{}},d=await ea.current.render(B(x),r,s,a.params,a.ppApplied,null!=z?z:void 0,{onProgress:e=>{ei.current===i&&Z(Math.max(1,Math.min(99,Math.round(100*e))))},onReport:e=>{ei.current===i&&(Y(e),et(t=>[e,...t].slice(0,10)))}},o);ei.current===i&&(y(d),Z(100),l({type:"PATCH",patch:{hasRenderedOnce:!0,pendingChanges:!1,overlaySticky:!1}}),es.current=ek())}else{let t=Math.max(8,Math.min(Math.floor(a.areaSize),x.width,x.height)),n=null!=(e=a.areaCenter)?e:{x:Math.floor(x.width/2),y:Math.floor(x.height/2)},o=Math.floor(t/2),d=Math.max(0,Math.min(n.x-o,x.width-t)),p=Math.max(0,Math.min(n.y-o,x.height-t)),c=function(e,t,a,i){let r=document.createElement("canvas");r.width=e.width,r.height=e.height;let s=r.getContext("2d",{willReadFrequently:!0});if(!s)throw Error("2D context");s.putImageData(e,0,0);let l=document.createElement("canvas");l.width=i,l.height=i;let n=l.getContext("2d",{willReadFrequently:!0});if(!n)throw Error("2D context");return n.drawImage(r,t,a,i,i,0,0,i,i),n.getImageData(0,0,i,i)}(x,d,p,t);if(ei.current!==i)return;l({type:"PATCH",patch:{areaCenter:n,areaCrop:{left:d,top:p,size:t}}}),j(c),C(null);let u=a.autoTileSize?void 0:a.tileSizePx,h={scale:1,partition:{x:d,y:p,w:t,h:t},parallel:a.parallelWorkers,poolSize:2,..."number"==typeof u?{tileSize:u}:{}},m=await ea.current.render(B(x),r,s,a.params,a.ppApplied,null!=z?z:void 0,{onProgress:e=>{ei.current===i&&Z(Math.max(1,Math.min(99,Math.round(100*e))))},onReport:e=>{ei.current===i&&(Y(e),et(t=>[e,...t].slice(0,10)))}},h);ei.current===i&&(C(m),Z(100),l({type:"PATCH",patch:{hasRenderedOnce:!0,pendingChanges:!1,overlaySticky:!1}}),es.current=ek())}}catch(a){let e=(null==a?void 0:a.message)||String(a);if("Operation cancelled"!==e&&(console.error(a),/webgl|context lost|webgl2|exhausted|limits unavailable|failed to create webgl/i.test(e))){Q(!1);try{null==(t=ea.current)||t.dispose()}catch(e){}}}finally{ei.current===i&&V(!1)}},[z,A,ek,n,x,a.areaCenter,a.areaSize,a.autoTileSize,a.maxShortSide,a.minShortSide,a.parallelWorkers,a.params,a.ppApplied,a.previewMode,a.tileSizePx]);(0,r.useEffect)(()=>{if(!x||A||a.isPreparingBaseline)return;let e=setTimeout(()=>{ez()},0);return()=>clearTimeout(e)},[ez,A,x,a.isPreparingBaseline]),(0,r.useEffect)(()=>{if(x){if("baselineEdit"===a.uiMode){let e=setTimeout(()=>{eO()},50);return()=>clearTimeout(e)}if(A&&"paint"===a.uiMode){try{var e;null==(e=ea.current)||e.cancel()}catch(e){}eA()}}},[x,A,a.uiMode]),(0,r.useEffect)(()=>{if("baselineEdit"!==a.uiMode||!x||a.isPreparingBaseline)return;let e=setTimeout(()=>{eO()},250);return()=>{clearTimeout(e);try{var t;null==(t=ea.current)||t.cancel()}catch(e){}}},[a.pp,a.depthMap,a.maxShortSide,a.uiMode,a.isPreparingBaseline,eO,x]),(0,r.useEffect)(()=>{if("paint"===a.uiMode&&x&&A&&(a.autoRenderOnEdit||!a.hasRenderedOnce)){try{var e;null==(e=ea.current)||e.cancel()}catch(e){}let t=setTimeout(()=>{eA()},300);return()=>{clearTimeout(t);try{var e;null==(e=ea.current)||e.cancel()}catch(e){}}}},[a.params,a.ppApplied,A,a.minShortSide,a.maxShortSide,a.previewMode,a.autoRenderOnEdit,a.hasRenderedOnce,eA,x,a.uiMode]),(0,r.useEffect)(()=>{if("paint"===a.uiMode&&x&&A&&(a.autoRenderOnEdit||!a.hasRenderedOnce)){try{var e;null==(e=ea.current)||e.cancel()}catch(e){}let t=setTimeout(()=>{eA()},150);return()=>{clearTimeout(t);try{var e;null==(e=ea.current)||e.cancel()}catch(e){}}}},[a.areaCenter,a.areaSize,A,a.autoRenderOnEdit,a.hasRenderedOnce,eA,x,a.uiMode]),(0,r.useEffect)(()=>{if("paint"!==a.uiMode||!A||!a.hasRenderedOnce||J)return void l({type:"PATCH",patch:{pendingChanges:!1,overlaySticky:!1}});let e=es.current;if(!e)return void l({type:"PATCH",patch:{pendingChanges:!1,overlaySticky:!1}});let t=!function(e,t){try{return JSON.stringify(e)===JSON.stringify(t)}catch(e){return!1}}(ek(),e);l({type:"PATCH",patch:{pendingChanges:t}}),t&&!a.autoRenderOnEdit&&l({type:"PATCH",patch:{overlaySticky:!0}}),t||l({type:"PATCH",patch:{overlaySticky:!1}})},[A,ek,J,a.autoRenderOnEdit,a.hasRenderedOnce,a.uiMode]),(0,r.useEffect)(()=>{if("baselineEdit"!==a.uiMode||!a.baselineHasAppliedOnce||a.isPreparingBaseline)return void l({type:"PATCH",patch:{baselinePendingChanges:!1,baselineOverlaySticky:!1}});let e=!1;try{e=JSON.stringify({pp:a.pp,depthMap:a.depthMap})!==JSON.stringify({pp:a.ppApplied,depthMap:a.depthMapApplied})}catch(t){e=!0}l({type:"PATCH",patch:{baselinePendingChanges:e,baselineOverlaySticky:e}})},[a.baselineHasAppliedOnce,a.depthMap,a.depthMapApplied,a.isPreparingBaseline,a.pp,a.ppApplied,a.uiMode]),(0,r.useEffect)(()=>{J&&a.overlaySticky&&l({type:"PATCH",patch:{overlaySticky:!1}})},[J,a.overlaySticky]);let eE=(0,r.useCallback)(e=>{if(!h||!en.current)return;let t=en.current.getBoundingClientRect(),i=e.clientX-t.left,r=e.clientY-t.top,s=h.naturalWidth/Math.max(1,t.width),n=h.naturalHeight/Math.max(1,t.height),o=Math.floor(i*s),d=Math.floor(r*n),p=Math.max(8,Math.min(a.areaSize,Math.min(h.naturalWidth,h.naturalHeight))),c=Math.floor(p/2),u=Math.max(c,Math.min(o,h.naturalWidth-c)),m=Math.max(c,Math.min(d,h.naturalHeight-c)),x=Math.max(0,Math.min(u-c,h.naturalWidth-p)),g=Math.max(0,Math.min(m-c,h.naturalHeight-p));l({type:"PATCH",patch:{areaCenter:{x:u,y:m},areaCrop:{left:x,top:g,size:p}}})},[h,a.areaSize]),eD=(0,r.useCallback)(()=>{Q(!0);try{var e;null==(e=ea.current)||e.dispose()}catch(e){}ea.current=new T;try{eA()}catch(e){}},[eA]),eT=(0,r.useMemo)(()=>({loadSampleSourceImage:eN,handleFile:eP,removeSource:eR,setUiMode:eo,setPreviewMode:ed,setZoom:ec,setZoomValue:ep,setParams:eu,setPp:eh,setDepthMap:em,setMinShortSide:ex,setMaxShortSide:eg,setTileSizePx:ef,setParallelWorkers:ey,setAutoTileSize:ev,setAutoRenderOnEdit:eb,setAreaSize:ew,onPickArea:eE,applyBaseline:ez,doPreview:eA,retryGpu:eD,setShowDiagnostics:eS,setSelectedReportIdx:eM,clearReportHistory:ej}),[ez,ej,eA,eP,eN,eE,eR,eD,ew,eb,ev,em,eg,ex,ey,eu,eh,ed,eM,eS,ef,eo,ec,ep]),eB=(0,r.useMemo)(()=>({imageSrc:n,originalImageSrc:d,sourceName:c,sourceInfo:w,img:h,sourceImageData:x,previewBefore:v,previewAfter:f,areaBefore:M,areaAfter:k,baselinePreprocessed:N,baselineDepthMap:z,baselineReady:A,ppPreviewAfter:E,ppPreviewDepth:q,ppIsBusy:_,isBusy:J,progress:G,gpuAvailable:$,lastReport:X,reportHistory:ee,diagRef:el,areaImgRef:en,NextImage:s.default}),[k,M,z,N,A,el,$,n,h,J,X,d,_,E,q,f,v,G,ee,x,w,c]);return(0,i.jsx)(W.Provider,{value:a,children:(0,i.jsx)(K.Provider,{value:eB,children:(0,i.jsx)(F.Provider,{value:eT,children:t})})})}function J(){var e,t,a,l,n,o,d,p,c;let h=q(),m=L(),g=_(),w=!!m.imageSrc,M="baselineEdit"===h.uiMode,j="paint"===h.uiMode,[k,C]=r.useState(null),P=r.useMemo(()=>{let e=h.params,t=e=>String(Math.round(e)),a=function(e){let t=Math.max(1,Math.min(6,Math.round(e)));return O.slice(0,t)}(e.layers),i=0!==e.minBrushPx?Math.abs(e.baseBrushPx/e.minBrushPx):1/0,r=[];r.push("Expected dab size (major\xd7minor px), t=0 → t=1:"),r.push("(Includes stroke pressure envelope; clamped to Min/Max brush.)");for(let i=0;i<a.length;i++){let s=a[i],{maxMajor:l,minMajor:n}=E({baseBrushPx:e.baseBrushPx,minBrushPx:e.minBrushPx},s),o={layerMinMajor:n,layerMaxMajor:l,layerMinMinor:.75/1.35*n,layerMaxMinor:.75/1.35*l},d=D(l,o),p=D(n,o);r.push("L".concat(i+1,"\xd7").concat(s.toFixed(2),": ")+"".concat(t(d.min.major),"–").concat(t(d.max.major),"\xd7").concat(t(d.min.minor),"–").concat(t(d.max.minor)," ")+"→ ".concat(t(p.min.major),"–").concat(t(p.max.major),"\xd7").concat(t(p.min.minor),"–").concat(t(p.max.minor)))}return r.push("Base/min ratio: ".concat(Number.isFinite(i)?i.toFixed(2):"∞")),r.join("\n")},[h.params]),T=r.useMemo(()=>{let e=h.params,t=e=>Number(e).toFixed(3).replace(/0+$/,"").replace(/\.$/,""),a=[];for(let i of(a.push("Depth samples (map value → majorPx):"),[0,.5,1])){let{tSize:r}=function(e,t){let a=A(Math.pow(A(e,0,1),.72),0,1),i=A(t.depthSizeStart,0,1),r=A(t.depthSizeEnd,0,1),s=Math.max(1e-6,A(Math.max(r,i+.001),0,1)-i),l=A((a-i)/s,0,1),n=function(e,t,a){let i=A((a-0)/(1-e),0,1);return i*i*(3-2*i)}(0,1,l),o=Math.pow(n,A(t.depthSizeCurve,.25,8));return{depth01:a,tLin:l,t:n,tSize:o}}(i,e),s=function(e,t,a){let{maxMajor:i,minMajor:r}=E(e,1);return i+(r-i)*A(a,0,1)}({baseBrushPx:e.baseBrushPx,minBrushPx:e.minBrushPx},0,r);a.push("d=".concat(t(i)," → tSize=").concat(t(r)," → major=").concat(t(s)))}return a.join("\n")},[h.params]);return r.useEffect(()=>{let e=m.baselineDepthMap;if(!e)return void C(null);let t=document.createElement("canvas");t.width=e.width,t.height=e.height;let a=t.getContext("2d",{willReadFrequently:!1});if(!a)return void C(null);a.putImageData(e,0,0),C(t.toDataURL("image/png"))},[m.baselineDepthMap]),(0,i.jsxs)("aside",{className:"w-[340px] max-h-full shrink-0 dark:border-gray-800 p-4 space-y-6 overflow-y-auto",children:[w?(0,i.jsxs)("div",{className:"space-y-3",children:[(0,i.jsx)("div",{className:"text-sm font-semibold",children:"Source"}),(0,i.jsxs)("div",{className:"rounded-lg border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-white/5 p-3",children:[(0,i.jsxs)("div",{className:"flex items-start gap-3",children:[(0,i.jsx)("div",{className:"relative w-20 h-14 rounded overflow-hidden bg-black/5 dark:bg-white/5 flex items-center justify-center flex-shrink-0",children:m.imageSrc&&(0,i.jsx)(s.default,{src:m.imageSrc,alt:"thumb",fill:!0,sizes:"80px",className:"object-cover"})}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("div",{className:"text-xs font-medium truncate",children:null!=(n=m.sourceName)?n:"(unnamed)"}),m.sourceInfo&&(0,i.jsxs)("div",{className:"mt-1 text-[10px] leading-4 text-gray-600 dark:text-gray-400",children:["Original: ",m.sourceInfo.origW,"\xd7",m.sourceInfo.origH,(0,i.jsx)("br",{}),"Working: ",m.sourceInfo.workW,"\xd7",m.sourceInfo.workH]})]})]}),(0,i.jsx)("div",{className:"flex flex-row justify-end",children:(0,i.jsx)(u,{variant:"outline",className:"",onClick:g.removeSource,children:"Replace"})})]}),j&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("div",{className:"text-sm font-semibold",children:"Baseline"}),(0,i.jsxs)("div",{className:"rounded-lg border overflow-hidden border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-white/5",children:[(0,i.jsx)("div",{className:"mb-0 relative bg-black/5 dark:bg-white/5 overflow-hidden ",children:k?(0,i.jsx)(s.default,{src:k,alt:"baseline pseudo depth map",fill:!0,sizes:"100vw",className:"object-contain",draggable:!1,unoptimized:!0}):(0,i.jsx)("div",{className:"aspect-video flex items-center justify-center",children:(0,i.jsx)("div",{className:"text-xs text-gray-500",children:"Preparing baseline…"})})}),(0,i.jsx)("div",{className:"p-3 border-t flex items-center justify-end",children:(0,i.jsx)(u,{variant:"outline",className:"",disabled:!m.baselineReady,onClick:()=>g.setUiMode("baselineEdit"),children:"Edit"})})]})]}),M&&(0,i.jsx)(u,{variant:"outline",className:"w-full h-auto py-3 text-xs justify-start",onClick:()=>g.setUiMode("paint"),children:"Back to Paint"})]}):(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("div",{className:"text-sm font-semibold",children:"Source"}),(0,i.jsx)("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Upload an image or choose a sample."}),(0,i.jsx)(b,{type:"file",accept:"image/*",className:"text-x",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&g.handleFile(a)}}),(0,i.jsx)("div",{className:"grid grid-cols-2 gap-2",children:R.map((e,t)=>(0,i.jsx)(u,{variant:"outline",className:"relative aspect-video py-2 text-xs w-full h-auto! overflow-hidden",onClick:()=>g.loadSampleSourceImage(t),children:(0,i.jsx)(m.NextImage,{fill:!0,src:e.src,alt:e.name,className:"object-cover"})},e.name))})]}),w&&M&&(0,i.jsxs)(f,{defaultOpen:!0,className:"space-y-4",children:[(0,i.jsx)(y,{className:"text-sm font-semibold cursor-pointer text-left",children:"Baseline"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsx)("div",{className:"text-[11px] p-2 rounded border "+(m.baselineReady?"border-emerald-500/60 bg-emerald-50 dark:bg-emerald-900/20":"border-amber-500/60 bg-amber-50 dark:bg-amber-900/20"),children:m.baselineReady?"Applied: preprocessing + pseudo depth are active (preprocessed ".concat(null!=(o=null==(e=m.baselinePreprocessed)?void 0:e.width)?o:0,"\xd7").concat(null!=(d=null==(t=m.baselinePreprocessed)?void 0:t.height)?d:0,", depth ").concat(null!=(p=null==(a=m.baselineDepthMap)?void 0:a.width)?p:0,"\xd7").concat(null!=(c=null==(l=m.baselineDepthMap)?void 0:l.height)?c:0,")."):"Baseline not ready yet."}),(0,i.jsx)(N,{label:"Work min short side (px)",value:h.minShortSide,allowOutOfRange:!0,min:z.baseline.limits.minShortSide.min,max:z.baseline.limits.minShortSide.max,step:z.baseline.limits.minShortSide.step,subtitle:"Upscales small images for preview/painting.",onChange:g.setMinShortSide}),(0,i.jsx)(N,{label:"Work max short side (px)",value:h.maxShortSide,allowOutOfRange:!0,min:z.baseline.limits.maxShortSide.min,max:z.baseline.limits.maxShortSide.max,step:z.baseline.limits.maxShortSide.step,subtitle:"Downscales large images for preview/painting.",onChange:g.setMaxShortSide}),(0,i.jsxs)(f,{className:"space-y-4",defaultOpen:!0,children:[(0,i.jsx)(y,{className:"text-xs font-semibold cursor-pointer text-left",children:"Preprocess"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(x,{checked:h.pp.enabled,onCheckedChange:e=>g.setPp(t=>({...t,enabled:!!e}))}),(0,i.jsx)(S,{className:"text-xs font-normal",children:"Enable preprocess"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(x,{checked:h.pp.blurEnabled,onCheckedChange:e=>g.setPp(t=>({...t,blurEnabled:!!e})),disabled:!h.pp.enabled}),(0,i.jsx)(S,{className:"text-xs font-normal",children:"Blur enabled"})]}),(0,i.jsx)(N,{label:"Blur radius",value:h.pp.blurRadius,allowOutOfRange:!0,min:z.preprocess.limits.blurRadius.min,max:z.preprocess.limits.blurRadius.max,step:z.preprocess.limits.blurRadius.step,onChange:e=>g.setPp(t=>({...t,blurRadius:e})),disabled:!h.pp.enabled||!h.pp.blurEnabled}),(0,i.jsx)(N,{label:"Blur amount",value:h.pp.blurAmount,allowOutOfRange:!0,min:z.preprocess.limits.blurAmount.min,max:z.preprocess.limits.blurAmount.max,step:z.preprocess.limits.blurAmount.step,onChange:e=>g.setPp(t=>({...t,blurAmount:e})),disabled:!h.pp.enabled||!h.pp.blurEnabled}),(0,i.jsx)(N,{label:"Saturation",value:h.pp.saturation,allowOutOfRange:!0,min:z.preprocess.limits.saturation.min,max:z.preprocess.limits.saturation.max,step:z.preprocess.limits.saturation.step,onChange:e=>g.setPp(t=>({...t,saturation:e})),disabled:!h.pp.enabled}),(0,i.jsx)(N,{label:"Brightness",value:h.pp.brightness,allowOutOfRange:!0,min:z.preprocess.limits.brightness.min,max:z.preprocess.limits.brightness.max,step:z.preprocess.limits.brightness.step,onChange:e=>g.setPp(t=>({...t,brightness:e})),disabled:!h.pp.enabled}),(0,i.jsx)(N,{label:"Warmth",value:h.pp.warmth,allowOutOfRange:!0,min:z.preprocess.limits.warmth.min,max:z.preprocess.limits.warmth.max,step:z.preprocess.limits.warmth.step,onChange:e=>g.setPp(t=>({...t,warmth:e})),disabled:!h.pp.enabled}),(0,i.jsx)(N,{label:"Tint",value:h.pp.tint,allowOutOfRange:!0,min:z.preprocess.limits.tint.min,max:z.preprocess.limits.tint.max,step:z.preprocess.limits.tint.step,onChange:e=>g.setPp(t=>({...t,tint:e})),disabled:!h.pp.enabled})]})]}),(0,i.jsxs)(f,{className:"space-y-4",defaultOpen:!0,children:[(0,i.jsx)(y,{className:"text-xs font-semibold cursor-pointer text-left",children:"Pseudo Depth"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsx)(N,{label:"Density radius",value:h.depthMap.densityRadius,allowOutOfRange:!0,min:z.depthMap.limits.densityRadius.min,max:z.depthMap.limits.densityRadius.max,step:z.depthMap.limits.densityRadius.step,subtitle:"How far edges fill into surfaces (edge-aware).",onChange:e=>g.setDepthMap(t=>({...t,densityRadius:e}))}),(0,i.jsx)(N,{label:"Density eps",value:h.depthMap.densityEps,allowOutOfRange:!0,min:z.depthMap.limits.densityEps.min,max:z.depthMap.limits.densityEps.max,step:z.depthMap.limits.densityEps.step,subtitle:"Higher = more spreading (can leak if too high).",onChange:e=>g.setDepthMap(t=>({...t,densityEps:e}))}),(0,i.jsx)(N,{label:"Final guided radius",value:h.depthMap.guidedRadius,allowOutOfRange:!0,min:z.depthMap.limits.guidedRadius.min,max:z.depthMap.limits.guidedRadius.max,step:z.depthMap.limits.guidedRadius.step,onChange:e=>g.setDepthMap(t=>({...t,guidedRadius:e}))}),(0,i.jsx)(N,{label:"Final guided eps",value:h.depthMap.guidedEps,allowOutOfRange:!0,min:z.depthMap.limits.guidedEps.min,max:z.depthMap.limits.guidedEps.max,step:z.depthMap.limits.guidedEps.step,subtitle:"Lower = stronger edge preservation.",onChange:e=>g.setDepthMap(t=>({...t,guidedEps:e}))}),(0,i.jsx)(N,{label:"Center prior weight",value:h.depthMap.centerWeight,allowOutOfRange:!0,min:z.depthMap.limits.centerWeight.min,max:z.depthMap.limits.centerWeight.max,step:z.depthMap.limits.centerWeight.step,subtitle:"Edge penalty: center unchanged, edges reduced.",onChange:e=>g.setDepthMap(t=>({...t,centerWeight:e}))}),(0,i.jsx)(N,{label:"Highlight boost",value:h.depthMap.highlightPower,allowOutOfRange:!0,min:z.depthMap.limits.highlightPower.min,max:z.depthMap.limits.highlightPower.max,step:z.depthMap.limits.highlightPower.step,subtitle:"Higher = brighter highlights, dims unchanged.",onChange:e=>g.setDepthMap(t=>({...t,highlightPower:e}))}),(0,i.jsx)(N,{label:"Highlight threshold",value:h.depthMap.highlightThreshold,allowOutOfRange:!0,min:z.depthMap.limits.highlightThreshold.min,max:z.depthMap.limits.highlightThreshold.max,step:z.depthMap.limits.highlightThreshold.step,subtitle:"Only values above this get boosted.",onChange:e=>g.setDepthMap(t=>({...t,highlightThreshold:e}))}),(0,i.jsx)(N,{label:"Output gamma",value:h.depthMap.gamma,allowOutOfRange:!0,min:z.depthMap.limits.gamma.min,max:z.depthMap.limits.gamma.max,step:z.depthMap.limits.gamma.step,subtitle:"Optional overall curve (affects midtones).",onChange:e=>g.setDepthMap(t=>({...t,gamma:e}))})]})]}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsx)(u,{variant:"outline",className:"",disabled:!m.sourceImageData||h.isPreparingBaseline,onClick:()=>void g.applyBaseline(),children:h.isPreparingBaseline?"Applying…":"Apply baseline"})})]})]}),w&&j&&(0,i.jsxs)(f,{defaultOpen:!0,className:"space-y-4",children:[(0,i.jsx)(y,{className:"text-sm font-semibold cursor-pointer text-left",children:"Output & Performance"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(x,{checked:!!h.params.debugMask,onCheckedChange:e=>g.setParams(t=>({...t,debugMask:!!e}))}),(0,i.jsx)(S,{className:"text-xs font-normal",children:"Debug: brush mask"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(x,{checked:h.autoRenderOnEdit,onCheckedChange:e=>{let t=!!e;if(t&&h.pendingChanges&&h.hasRenderedOnce&&!m.isBusy)try{g.doPreview()}catch(e){}g.setAutoRenderOnEdit(t)}}),(0,i.jsx)(S,{className:"text-xs font-normal",children:"Auto render on edit"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(x,{checked:h.parallelWorkers,onCheckedChange:e=>g.setParallelWorkers(!!e)}),(0,i.jsx)(S,{className:"text-xs font-normal",children:"Parallel render (2 workers)"})]}),(0,i.jsx)(N,{label:"Tile size (px)",value:h.tileSizePx,allowOutOfRange:!0,disabled:h.autoTileSize,min:z.performance.limits.tileSizePx.min,max:z.performance.limits.tileSizePx.max,step:z.performance.limits.tileSizePx.step,subtitle:"Larger tiles are faster but use more GPU memory.",onChange:g.setTileSizePx}),(0,i.jsx)(N,{label:"Area preview size (px)",value:h.areaSize,allowOutOfRange:!0,min:z.view.limits.areaSize.min,max:z.view.limits.areaSize.max,step:z.view.limits.areaSize.step,onChange:g.setAreaSize})]})]}),w&&j&&(0,i.jsxs)(f,{defaultOpen:!0,className:"space-y-4",children:[(0,i.jsx)(y,{className:"text-sm font-semibold cursor-pointer text-left",children:"Brush Size"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsx)(N,{label:"Base brush (px)",value:h.params.baseBrushPx,allowOutOfRange:!0,min:z.paint.limits.baseBrushPx.min,max:z.paint.limits.baseBrushPx.max,step:z.paint.limits.baseBrushPx.step,subtitle:"Hard maximum stroke size (coarse→fine layers scale down from this).\n\n"+P,onChange:e=>g.setParams(t=>({...t,baseBrushPx:e}))}),(0,i.jsx)(N,{label:"Min brush (px)",value:h.params.minBrushPx,allowOutOfRange:!0,min:z.paint.limits.minBrushPx.min,max:z.paint.limits.minBrushPx.max,step:z.paint.limits.minBrushPx.step,subtitle:"Hard minimum stroke size (used at closest depth).",onChange:e=>g.setParams(t=>({...t,minBrushPx:e}))}),(0,i.jsx)(N,{label:"Layers",value:h.params.layers,allowOutOfRange:!0,min:z.paint.limits.layers.min,max:z.paint.limits.layers.max,step:z.paint.limits.layers.step,subtitle:"More layers adds finer detail but costs time.",onChange:e=>g.setParams(t=>({...t,layers:e}))}),(0,i.jsx)(N,{label:"Depth range",value:[h.params.depthSizeStart,h.params.depthSizeEnd],allowOutOfRange:!0,min:z.paint.limits.depthSizeStart.min,max:z.paint.limits.depthSizeEnd.max,step:z.paint.limits.depthSizeStart.step,subtitle:"Controls where shrinking starts and where it reaches Min brush.\nStart (from): lower = affects more of the image.\nEnd (to): lower = reaches min sooner.",onChange:e=>{g.setParams(t=>{let a=Math.max(0,Math.min(1,e[0])),i=Math.max(0,Math.min(1,e[1])),r=Math.min(a,i),s=Math.max(i,Math.min(1,r+.01));return{...t,depthSizeStart:r,depthSizeEnd:s}})}}),(0,i.jsx)(N,{label:"Depth size curve",value:h.params.depthSizeCurve,allowOutOfRange:!0,min:z.paint.limits.depthSizeCurve.min,max:z.paint.limits.depthSizeCurve.max,step:z.paint.limits.depthSizeCurve.step,subtitle:"Shapes how quickly size drops: higher keeps backgrounds large and compresses the smallest strokes.\n\n"+T,onChange:e=>g.setParams(t=>({...t,depthSizeCurve:e}))})]})]}),w&&j&&(0,i.jsxs)(f,{defaultOpen:!0,className:"space-y-4",children:[(0,i.jsx)(y,{className:"text-sm font-semibold cursor-pointer text-left",children:"Brush Appearance"}),(0,i.jsxs)(v,{className:"space-y-4",children:[(0,i.jsx)(N,{label:"Opacity",value:h.params.opacity,allowOutOfRange:!0,min:z.paint.limits.opacity.min,max:z.paint.limits.opacity.max,step:z.paint.limits.opacity.step,subtitle:"Higher opacity makes strokes more visible.",onChange:e=>g.setParams(t=>({...t,opacity:e}))}),(0,i.jsx)(N,{label:"Jitter",value:h.params.jitter,allowOutOfRange:!0,min:z.paint.limits.jitter.min,max:z.paint.limits.jitter.max,step:z.paint.limits.jitter.step,subtitle:"Randomness in placement along the stroke lattice.",onChange:e=>g.setParams(t=>({...t,jitter:e}))}),(0,i.jsx)(N,{label:"Density",value:h.params.density,allowOutOfRange:!0,min:z.paint.limits.density.min,max:z.paint.limits.density.max,step:z.paint.limits.density.step,subtitle:"Higher density places more strokes (slower but fuller coverage).",onChange:e=>g.setParams(t=>({...t,density:e}))}),(0,i.jsx)(N,{label:"Stroke length",value:h.params.strokeLength,allowOutOfRange:!0,min:z.paint.limits.strokeLength.min,max:z.paint.limits.strokeLength.max,step:z.paint.limits.strokeLength.step,subtitle:"Number of dabs per dragged stroke (higher = longer pulls; slower).",onChange:e=>g.setParams(t=>({...t,strokeLength:e}))}),(0,i.jsx)(N,{label:"Stroke overlap",value:h.params.strokeOverlap,allowOutOfRange:!0,min:z.paint.limits.strokeOverlap.min,max:z.paint.limits.strokeOverlap.max,step:z.paint.limits.strokeOverlap.step,subtitle:"Higher overlap makes strokes look more continuous (slower).",onChange:e=>g.setParams(t=>({...t,strokeOverlap:e}))}),(0,i.jsx)(N,{label:"Seed",value:h.params.seed,allowOutOfRange:!0,min:z.paint.limits.seed.min,max:z.paint.limits.seed.max,step:z.paint.limits.seed.step,subtitle:"Deterministic random seed.",onChange:e=>g.setParams(t=>({...t,seed:e}))})]})]})]})}function V(e){let{imageData:t,zoom:a,cssFilter:s,className:l,style:n}=e,o=(0,r.useRef)(null);return(0,r.useEffect)(()=>{let e=!1;return(async()=>{let i=o.current;if(!i)return;let r=Math.max(1,Math.floor(t.width*Math.max(.01,a))),s=Math.max(1,Math.floor(t.height*Math.max(.01,a)));i.width=r,i.height=s;let l=i.getContext("2d");if(l)try{let a=await createImageBitmap(t);if(e){try{a.close()}catch(e){}return}l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.clearRect(0,0,r,s),l.drawImage(a,0,0,r,s);try{a.close()}catch(e){}}catch(i){let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let a=e.getContext("2d");if(a)try{a.putImageData(t,0,0),l.drawImage(e,0,0,r,s)}catch(e){}}})(),()=>{e=!0}},[t,a]),(0,i.jsx)("canvas",{ref:o,className:null!=l?l:"block max-w-full h-auto mx-auto rounded",style:{...s?{filter:s}:{},...n||{}}})}function G(e){let{imageEl:t,naturalWidth:a,naturalHeight:s,areaCenter:l,areaSize:n,areaAfter:o,isBusy:d,areaCrop:p}=e,[c,u]=(0,r.useState)({w:0,h:0});if((0,r.useEffect)(()=>{if(!t)return;let e=new ResizeObserver(e=>{var a;let i=null==(a=e[0])?void 0:a.contentRect;i?u({w:Math.round(i.width),h:Math.round(i.height)}):u({w:t.clientWidth,h:t.clientHeight})});return u({w:t.clientWidth,h:t.clientHeight}),e.observe(t),()=>{try{e.disconnect()}catch(e){}}},[t]),!t||!l||0===c.w||0===c.h)return null;let h=c.w/Math.max(1,a),m=c.h/Math.max(1,s),x=p?p.size:Math.max(8,Math.min(Math.floor(n),Math.min(a,s))),g=Math.floor(x/2),f=p?p.left+g:Math.max(g,Math.min(l.x,a-g)),y=p?p.top+g:Math.max(g,Math.min(l.y,s-g)),v=p?p.left:f-g,b=p?p.top:y-g,w=Math.round(v*h),S=Math.round(b*m),M=Math.max(1,Math.round(x*h)),j=Math.max(1,Math.round(x*m));return(0,i.jsx)("div",{style:{position:"absolute",left:w,top:S,width:M,height:j,outline:"1px solid #fff5",pointerEvents:"none",overflow:"hidden"},children:!d&&o?(0,i.jsx)(V,{imageData:o,zoom:1,className:"block w-full h-full",style:{width:"100%",height:"100%"}}):null})}var Z=a(9476),$=a(988);function Q(e){let{className:t,...a}=e;return(0,i.jsx)($.YJ,{"data-slot":"resizable-panel-group",className:p("flex h-full w-full aria-[orientation=vertical]:flex-col",t),...a})}function X(e){let{...t}=e;return(0,i.jsx)($.Zk,{"data-slot":"resizable-panel",...t})}function Y(e){let{withHandle:t,className:a,...r}=e;return(0,i.jsx)($.wv,{"data-slot":"resizable-handle",className:p("bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden aria-[orientation=horizontal]:h-px aria-[orientation=horizontal]:w-full aria-[orientation=horizontal]:after:left-0 aria-[orientation=horizontal]:after:h-1 aria-[orientation=horizontal]:after:w-full aria-[orientation=horizontal]:after:translate-x-0 aria-[orientation=horizontal]:after:-translate-y-1/2 [&[aria-orientation=horizontal]>div]:rotate-90",a),...r,children:t&&(0,i.jsx)("div",{className:"bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border",children:(0,i.jsx)(Z.A,{className:"size-2.5"})})})}function ee(e){let{before:t,after:a,initialPosition:s=.42,className:l,labels:n}=e,o=(0,r.useId)(),d="".concat(o,"-before"),p="".concat(o,"-after"),c=(0,r.useRef)(null),u=(0,r.useMemo)(()=>Math.max(0,Math.min(1,s)),[s]),[h,m]=(0,r.useState)(u),x=(0,r.useMemo)(()=>Math.round(1e3*u)/10,[u]),g=(0,r.useMemo)(()=>100-x,[x]),f=Math.round((1-h)*100);return(0,i.jsxs)("div",{ref:c,className:"relative select-none overflow-hidden rounded-lg group "+(null!=l?l:""),role:"group","aria-label":"Before/After comparison",children:[(0,i.jsx)("div",{className:"relative z-0",children:a}),(0,i.jsx)("div",{className:"absolute inset-0",style:{clipPath:"inset(0% ".concat(f,"% 0% 0%)"),WebkitClipPath:"inset(0% ".concat(f,"% 0% 0%)")},"aria-hidden":!0,children:(0,i.jsx)("div",{className:"absolute inset-0",children:t})}),(0,i.jsx)("div",{className:"absolute inset-0 z-10 pointer-events-none",children:(0,i.jsxs)(Q,{orientation:"horizontal",className:"h-full w-full pointer-events-none",onLayoutChange:e=>{let t=null==e?void 0:e[d];"number"==typeof t&&isFinite(t)&&m(Math.max(0,Math.min(1,t/100)))},children:[(0,i.jsx)(X,{id:d,defaultSize:x,minSize:0}),(0,i.jsx)(Y,{withHandle:!0,className:"pointer-events-auto"}),(0,i.jsx)(X,{id:p,defaultSize:g,minSize:0})]})}),(null==n?void 0:n.before)&&(0,i.jsx)("div",{className:"absolute left-2 top-2 text-xs px-2 py-1 rounded bg-black/50 text-white",children:n.before}),(null==n?void 0:n.after)&&(0,i.jsx)("div",{className:"absolute right-2 top-2 text-xs px-2 py-1 rounded bg-black/50 text-white",children:n.after})]})}function et(){var e,t,a,r,l,n,o;let d=q(),p=L(),c=_(),h=!!p.imageSrc,m="baselineEdit"===d.uiMode,x="paint"===d.uiMode;return(0,i.jsxs)("main",{className:"flex flex-col flex-1 p-4",children:[(0,i.jsxs)("div",{className:"flex-none flex items-center justify-between mb-3",children:[(0,i.jsxs)("div",{className:"flex items-center gap-1 mr-2",children:[h&&x&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(u,{variant:"area"===d.previewMode?"default":"outline",className:"",onClick:()=>c.setPreviewMode("area"),disabled:!p.baselineReady,children:"Area Preview"}),(0,i.jsx)(u,{variant:"compare"===d.previewMode?"default":"outline",className:"",onClick:()=>c.setPreviewMode("compare"),disabled:!p.baselineReady,children:"Full Preview"})]}),h&&m&&(0,i.jsx)("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Baseline edit preview"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(u,{variant:"outline",size:"icon-xs",className:"text-xs",onClick:()=>c.setZoom(e=>Math.max(.25,e-.25)),children:"−"}),(0,i.jsxs)("span",{className:"text-xs w-16 text-center",children:[Math.round(100*d.zoom),"%"]}),(0,i.jsx)(u,{variant:"outline",size:"icon-xs",className:"text-xs",onClick:()=>c.setZoom(e=>Math.min(4,e+.25)),children:"+"}),(0,i.jsx)(u,{variant:"outline",className:"",onClick:()=>c.setZoomValue(1),children:"Reset"}),(0,i.jsx)(u,{variant:d.showDiagnostics?"default":"outline",className:"",onClick:()=>c.setShowDiagnostics(!d.showDiagnostics),title:d.showDiagnostics?"Hide diagnostics":"Show diagnostics",children:"Diagnostics"}),h&&x&&(0,i.jsx)(u,{variant:"outline",className:"",disabled:!p.previewAfter||p.isBusy||!p.baselineReady,onClick:()=>{let e=p.previewAfter;if(!e)return;let t=document.createElement("canvas");t.width=e.width,t.height=e.height;let a=t.getContext("2d");a&&(a.putImageData(e,0,0),t.toBlob(e=>{if(!e)return;let t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="atelier.png",a.click(),setTimeout(()=>URL.revokeObjectURL(t),0)},"image/png"))},children:"Download PNG"})]})]}),(0,i.jsxs)("div",{className:"relative flex-1 flex flex-col justify-center bg-gray-200 dark:bg-gray-800 rounded-xl min-h-[360px]",children:[(0,i.jsxs)("div",{className:"flex-none max-h-full overflow-y-auto p-4",children:[!p.imageSrc&&(0,i.jsx)("div",{className:"h-[480px] flex items-center justify-center text-sm text-gray-500",children:"Upload an image to start."}),p.imageSrc&&x&&!p.baselineReady&&(0,i.jsx)("div",{className:"h-[480px] flex items-center justify-center text-sm text-gray-500",children:"Preparing baseline…"}),p.imageSrc&&m&&p.sourceImageData&&(0,i.jsx)(ee,{className:"w-full",labels:{before:"Preprocessed",after:p.gpuAvailable?p.ppIsBusy||!p.ppPreviewDepth?"Processing…":"Pseudo Depth":"GPU unavailable"},before:(0,i.jsx)(V,{imageData:null!=(a=p.ppPreviewAfter)?a:p.sourceImageData,zoom:d.zoom}),after:p.ppIsBusy||!p.ppPreviewDepth?(0,i.jsx)(V,{imageData:null!=(r=p.ppPreviewAfter)?r:p.sourceImageData,zoom:d.zoom,cssFilter:"blur(8px)"}):(0,i.jsx)(V,{imageData:p.ppPreviewDepth,zoom:d.zoom})}),p.imageSrc&&x&&"compare"===d.previewMode&&p.previewBefore&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ee,{className:"w-full",labels:{before:"Before",after:p.gpuAvailable?p.isBusy||!p.previewAfter?"Previewing…":"After":"GPU unavailable"},before:(0,i.jsx)(V,{imageData:p.previewBefore,zoom:d.zoom}),after:p.isBusy||!p.previewAfter?(0,i.jsx)(V,{imageData:p.previewBefore,zoom:d.zoom,cssFilter:"blur(8px)"}):(0,i.jsx)(V,{imageData:p.previewAfter,zoom:d.zoom})}),p.isBusy&&(0,i.jsxs)("div",{className:"absolute right-3 bottom-3 text-xs px-2 py-1 rounded bg-black/60 text-white",children:[p.progress,"%"]})]}),p.imageSrc&&x&&"area"===d.previewMode&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"w-full flex justify-center",children:(0,i.jsxs)("div",{className:"relative overflow-clip inline-block max-w-full",style:{maxWidth:"400px",maxHeight:"400px"},children:[(0,i.jsx)(s.default,{ref:p.areaImgRef,src:p.imageSrc,alt:"original",width:null!=(l=null==(e=p.img)?void 0:e.naturalWidth)?l:1,height:null!=(n=null==(t=p.img)?void 0:t.naturalHeight)?n:1,sizes:"(max-width: 640px) 100vw, 400px",className:"rounded",style:{width:"100%",height:"auto"},onClick:c.onPickArea,onLoad:()=>{p.areaImgRef.current&&c.setSelectedReportIdx(d.selectedReportIdx)}}),p.img&&(0,i.jsx)(G,{imageEl:p.areaImgRef.current,naturalWidth:p.img.naturalWidth,naturalHeight:p.img.naturalHeight,areaCenter:d.areaCenter,areaSize:d.areaSize,areaAfter:p.areaAfter,isBusy:p.isBusy,areaCrop:d.areaCrop})]})}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-4 max-w-4xl mx-auto",children:[(0,i.jsx)("div",{className:"aspect-square bg-black/5 dark:bg-white/5 rounded flex items-center justify-center overflow-hidden",children:p.areaBefore?(0,i.jsx)(V,{imageData:p.areaBefore,zoom:1}):(0,i.jsx)("div",{className:"text-xs text-gray-500",children:"Pick a point"})}),(0,i.jsxs)("div",{className:"relative aspect-square bg-black/5 dark:bg-white/5 rounded flex items-center justify-center overflow-hidden",children:[p.isBusy&&p.areaBefore&&!p.areaAfter&&(0,i.jsx)(V,{imageData:p.areaBefore,zoom:1,cssFilter:"blur(8px)"}),p.areaAfter?(0,i.jsx)(V,{imageData:p.areaAfter,zoom:1}):null,p.isBusy&&(0,i.jsxs)("div",{className:"absolute right-3 bottom-3 text-xs px-2 py-1 rounded bg-black/60 text-white",children:[p.progress,"%"]})]})]})]})]}),m&&d.baselineHasAppliedOnce&&!d.isPreparingBaseline&&(d.baselinePendingChanges||d.baselineOverlaySticky)&&(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"px-4 py-3 rounded-md bg-black/60 text-white text-xs flex items-center gap-3 shadow-lg",children:[(0,i.jsx)("span",{children:"Baseline settings changed. Apply now?"}),(0,i.jsx)(u,{variant:"outline",className:"h-auto px-2 py-1 text-xs border-white/40 bg-white/10 hover:bg-white/20",onClick:()=>{c.applyBaseline()},children:"Apply baseline"})]})}),x&&d.hasRenderedOnce&&!p.isBusy&&(d.pendingChanges&&!d.autoRenderOnEdit||d.overlaySticky)&&(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"px-4 py-3 rounded-md bg-black/60 text-white text-xs flex items-center gap-3 shadow-lg",children:[(0,i.jsx)("span",{children:"Settings changed. Re-render now?"}),(0,i.jsx)(u,{variant:"outline",className:"h-auto px-2 py-1 text-xs border-white/40 bg-white/10 hover:bg-white/20",onClick:()=>{c.doPreview()},children:"Re-render"})]})}),!p.gpuAvailable&&(0,i.jsxs)("div",{className:"absolute left-4 bottom-4 right-4 sm:right-auto sm:max-w-xl text-xs px-3 py-2 rounded bg-yellow-200/90 text-yellow-900 dark:bg-yellow-500/20 dark:text-yellow-200 border border-yellow-400/60 flex items-start justify-between gap-3",children:[(0,i.jsxs)("div",{className:"min-w-0",children:[(0,i.jsx)("div",{children:"GPU/WebGL became unavailable. Results are limited. Try retrying or reloading."}),p.lastReport&&(0,i.jsxs)("div",{className:"mt-1 text-[11px] text-yellow-900/90 dark:text-yellow-200/80",children:[(0,i.jsxs)("span",{className:"mr-2",children:["Failed step: ",(0,i.jsx)("b",{children:null!=(o=p.lastReport.failedStep)?o:"—"})]}),p.lastReport.exception&&(0,i.jsxs)("span",{className:"mr-2",children:["Error: ",p.lastReport.exception]}),p.lastReport.vendor&&p.lastReport.renderer&&(0,i.jsxs)("span",{className:"mr-2",children:["GPU: ",p.lastReport.vendor," \xb7 ",p.lastReport.renderer]})]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[p.lastReport&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(u,{variant:"outline",className:"h-auto px-2 py-1 text-xs border-yellow-700/30 bg-white/70 dark:bg-white/10",onClick:()=>{c.setShowDiagnostics(!0),setTimeout(()=>{try{var e;null==(e=p.diagRef.current)||e.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){}},0)},title:"Scroll to diagnostics",children:"Details"}),(0,i.jsx)(u,{variant:"outline",className:"h-auto px-2 py-1 text-xs border-yellow-700/30 bg-white/70 dark:bg-white/10",onClick:async()=>{try{await navigator.clipboard.writeText(JSON.stringify(p.lastReport,null,2))}catch(e){}},title:"Copy report JSON",children:"Copy report"})]}),(0,i.jsx)(u,{variant:"outline",className:"h-auto px-2 py-1 text-xs border-yellow-700/30 bg-white/60 dark:bg-white/10",onClick:c.retryGpu,children:"Retry"})]})]})]}),d.showDiagnostics&&(0,i.jsxs)("div",{ref:p.diagRef,className:"mt-3 text-[11px] leading-5 bg-white/70 dark:bg-black/30 backdrop-blur rounded border border-gray-300 dark:border-gray-700 p-3 max-w-full overflow-x-auto",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("div",{className:"font-semibold",children:"Render Diagnostics"}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("div",{className:"text-[10px] text-gray-600 dark:text-gray-300",children:p.reportHistory.length>0?"Showing ".concat(d.selectedReportIdx>=0?"history #".concat(d.selectedReportIdx+1):"latest"):"—"}),(0,i.jsx)(u,{variant:"outline",size:"xs",className:"h-auto py-0.5 text-[10px]",onClick:()=>c.setShowDiagnostics(!1),title:"Hide diagnostics",children:"Hide"})]})]}),(0,i.jsxs)("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[(0,i.jsx)("span",{className:"text-[10px] text-gray-500",children:"History:"}),0===p.reportHistory.length&&(0,i.jsx)("span",{className:"text-[10px] text-gray-400",children:"—"}),p.reportHistory.map((e,t)=>{var a,r,s,l,n;return(0,i.jsxs)(u,{variant:t===d.selectedReportIdx?"default":"outline",size:"xs",className:"h-auto py-0.5 text-[10px]",onClick:()=>c.setSelectedReportIdx(t===d.selectedReportIdx?-1:t),title:"Select report ".concat(t+1),"aria-pressed":t===d.selectedReportIdx,children:[null!=(r=e.mode)?r:"paint","/",Math.round(null!=(l=null!=(s=e.durationMs)?s:null==(a=e.worker)?void 0:a.overallMs)?l:0),"ms"]},(null!=(n=e.requestId)?n:"")+"-"+t)}),p.reportHistory.length>0&&(0,i.jsx)(u,{variant:"outline",size:"xs",className:"ml-2 h-auto py-0.5 text-[10px]",onClick:c.clearReportHistory,children:"Clear"}),d.selectedReportIdx>=0&&(0,i.jsx)(u,{variant:"outline",size:"xs",className:"ml-1 h-auto py-0.5 text-[10px]",onClick:()=>c.setSelectedReportIdx(-1),title:"View latest report",children:"Latest"})]}),(()=>{var e,t,a,r,s;let l=d.selectedReportIdx>=0?p.reportHistory[d.selectedReportIdx]:p.lastReport;if(!l)return(0,i.jsx)("div",{className:"mt-2 text-[10px] text-gray-600 dark:text-gray-300",children:"Run a render to see diagnostics here."});let n={source:{imageSrc:p.imageSrc,minShortSide:d.minShortSide,maxShortSide:d.maxShortSide},baseline:{ready:p.baselineReady,version:d.baselineVersion,preprocessApplied:d.ppApplied,depthMapApplied:d.depthMapApplied,preprocessDraft:d.pp,depthMapDraft:d.depthMap},paint:d.params,view:{previewMode:d.previewMode,areaSize:d.areaSize,areaCenter:d.areaCenter,zoom:d.zoom},performance:{tileSizePx:d.tileSizePx,autoTileSize:d.autoTileSize,parallelWorkers:d.parallelWorkers,autoRenderOnEdit:d.autoRenderOnEdit}};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-1",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-500",children:"Duration:"})," ",Math.round(null!=(a=null!=(t=l.durationMs)?t:null==(e=l.worker)?void 0:e.overallMs)?a:0),"ms"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-500",children:"WebGL:"})," ",null!=(r=l.webglVersion)?r:"—"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-500",children:"Renderer:"})," ",null!=(s=l.renderer)?s:"—"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-500",children:"Tile:"})," ",d.autoTileSize?"auto":d.tileSizePx]})]}),l.timings&&(0,i.jsxs)(f,{className:"mt-2",children:[(0,i.jsx)(y,{className:"text-[10px] font-semibold cursor-pointer text-left",children:"Timings"}),(0,i.jsx)(v,{className:"mt-1 whitespace-pre",children:JSON.stringify(l.timings,null,2)})]}),l.limits&&(0,i.jsxs)(f,{className:"mt-2",children:[(0,i.jsx)(y,{className:"text-[10px] font-semibold cursor-pointer text-left",children:"Limits"}),(0,i.jsx)(v,{className:"mt-1 whitespace-pre",children:JSON.stringify(l.limits,null,2)})]}),l.parallel&&l.parallel.enabled&&(0,i.jsxs)(f,{className:"mt-2",children:[(0,i.jsx)(y,{className:"text-[10px] font-semibold cursor-pointer text-left",children:"Parallel"}),(0,i.jsx)(v,{className:"mt-1 whitespace-pre",children:JSON.stringify(l.parallel,null,2)})]}),(0,i.jsxs)(f,{className:"mt-2",children:[(0,i.jsx)(y,{className:"text-[10px] font-semibold cursor-pointer text-left",children:"Settings"}),(0,i.jsx)(v,{className:"mt-1 whitespace-pre",children:JSON.stringify(n,null,2)})]}),(0,i.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,i.jsx)(u,{variant:"outline",size:"xs",className:"h-auto py-0.5 text-[10px]",onClick:async()=>{try{await navigator.clipboard.writeText(JSON.stringify(l,null,2))}catch(e){}},children:"Copy report"}),(0,i.jsx)(u,{variant:"outline",size:"xs",className:"h-auto py-0.5 text-[10px]",onClick:async()=>{try{await navigator.clipboard.writeText(JSON.stringify(n,null,2))}catch(e){}},children:"Copy settings"})]})]})})()]})]})}function ea(){return(0,i.jsxs)("div",{className:"flex h-screen text-gray-900 dark:text-gray-100",children:[(0,i.jsx)(J,{}),(0,i.jsx)(et,{})]})}function ei(){return(0,i.jsx)(U,{children:(0,i.jsx)(ea,{})})}}},e=>{e.O(0,[503,693,623,358],()=>e(e.s=5697)),_N_E=e.O()}]);