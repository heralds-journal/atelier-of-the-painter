(()=>{var t={3965:t=>{!function(){var e={229:function(t){var e,r,i,a=t.exports={};function l(){throw Error("setTimeout has not been defined")}function n(){throw Error("clearTimeout has not been defined")}try{e="function"==typeof setTimeout?setTimeout:l}catch(t){e=l}try{r="function"==typeof clearTimeout?clearTimeout:n}catch(t){r=n}function o(t){if(e===setTimeout)return setTimeout(t,0);if((e===l||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(r){try{return e.call(null,t,0)}catch(r){return e.call(this,t,0)}}}var s=[],h=!1,u=-1;function g(){h&&i&&(h=!1,i.length?s=i.concat(s):u=-1,s.length&&c())}function c(){if(!h){var t=o(g);h=!0;for(var e=s.length;e;){for(i=s,s=[];++u<e;)i&&i[u].run();u=-1,e=s.length}i=null,h=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===n||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function d(){}a.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];s.push(new f(t,e)),1!==s.length||h||o(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=d,a.addListener=d,a.once=d,a.off=d,a.removeListener=d,a.removeAllListeners=d,a.emit=d,a.prependListener=d,a.prependOnceListener=d,a.listeners=function(t){return[]},a.binding=function(t){throw Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(t){throw Error("process.chdir is not supported")},a.umask=function(){return 0}}},r={};function i(t){var a=r[t];if(void 0!==a)return a.exports;var l=r[t]={exports:{}},n=!0;try{e[t](l,l.exports,i),n=!1}finally{n&&delete r[t]}return l.exports}i.ab="//",t.exports=i(229)}()},5704:(t,e,r)=>{"use strict";var i,a;t.exports=(null==(i=r.g.process)?void 0:i.env)&&"object"==typeof(null==(a=r.g.process)?void 0:a.env)?r.g.process:r(3965)}},e={};function r(i){var a=e[i];if(void 0!==a)return a.exports;var l=e[i]={exports:{}},n=!0;try{t[i](l,l.exports,r),n=!1}finally{n&&delete e[i]}return l.exports}r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{"use strict";var t=r(5704);class e{log(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];e.DEBUG&&console.log("[GPU]",...r)}info(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];e.DEBUG&&console.info("[GPU]",...r)}warnLog(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];console.warn("[GPU]",...e)}errLog(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];console.error("[GPU]",...e)}getLastReport(){return this.lastReport?{...this.lastReport}:null}now(){try{if("undefined"!=typeof performance&&"function"==typeof performance.now)return performance.now()}catch(t){}return Date.now()}glErrorLabel(t){let e=this.gl;return({[e.NO_ERROR]:"NO_ERROR",[e.INVALID_ENUM]:"INVALID_ENUM",[e.INVALID_VALUE]:"INVALID_VALUE",[e.INVALID_OPERATION]:"INVALID_OPERATION",[e.INVALID_FRAMEBUFFER_OPERATION]:"INVALID_FRAMEBUFFER_OPERATION",[e.OUT_OF_MEMORY]:"OUT_OF_MEMORY",[e.CONTEXT_LOST_WEBGL]:"CONTEXT_LOST_WEBGL"})[t]||"0x".concat(t.toString(16))}createCanvas2D(t,e){if("undefined"!=typeof OffscreenCanvas){let r=new OffscreenCanvas(t,e),i=r.getContext("2d",{willReadFrequently:!0});if(!i)throw Error("2D context unavailable");return{canvas:r,ctx:i}}if("undefined"!=typeof document){let r=document.createElement("canvas");r.width=t,r.height=e;let i=r.getContext("2d",{willReadFrequently:!0});if(!i)throw Error("2D context unavailable");return{canvas:r,ctx:i}}throw Error("No canvas implementation available")}computeOverlapPixels(t){var e,r;let i=Math.min(3,t.upscaleFactor),a=t.preserveSettings?i:1,l=Math.max(1,Math.floor(t.kernelSize*a*.5))*(null!=(e=t.radiusMaxScale)?e:1)*Math.max(1,t.anisotropy);return Math.min(Math.ceil(l+(null!=(r=t.flowSigma)?r:2)*2+3),128)}async applyFilterTiled(t,e,r,i,a,l){var n,o;if(this.contextLost||this.gl.isContextLost())throw this.warnLog("applyFilterTiled: context lost at entry"),Error("WebGL context lost");let s=t.width,h=t.height,u=Math.max(1,Math.floor(null!=(n=null==r?void 0:r.scale)?n:1)),g=Math.max(1,Math.floor(s*u)),c=Math.max(1,Math.floor(h*u)),f=Math.min(3,e.upscaleFactor),d=this.computeOverlapPixels({...e,upscaleFactor:f}),m=new Uint8ClampedArray(g*c*4),{ctx:E}=this.createCanvas2D(1,1);if(!E)throw Error("2D context unavailable");E.imageSmoothingEnabled=!1;let p=async(n,o)=>{var f;if(null==a?void 0:a.aborted)throw Error("Operation cancelled");let E=0;try{E=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)}catch(t){this.warnLog("applyFilterTiled: failed MAX_TEXTURE_SIZE query")}let x=Math.max(256,Math.min(512,Math.floor((E||1024)/4))),_=Math.max(256,512-2*d),M=Math.min(x,_),R=Math.max(128,Math.min(n||(null!=(f=null==r?void 0:r.tileSize)?f:M),M)),T=Math.max(128,Math.min(Math.max(128,Math.min((E||4096)-2*d,R,_)),R)),v=0,b=Math.ceil(g/T)*Math.ceil(c/T);l&&l(0,b),this.log("Tiling",{attempt:o,srcW:s,srcH:h,tileW:T,tileH:T,overlap:d,expandedHardCap:512,coreCapByExpanded:_,targetCore:x,maxTex:E});for(let r=0;r<c;r+=T){let n=Math.min(T,c-r),f=r,E=Math.max(0,f-d),x=Math.min(c,r+n+d)-E;for(let c=0;c<g;c+=T){if(null==a?void 0:a.aborted)throw Error("Operation cancelled");let _=Math.min(T,g-c),M=c,R=Math.max(0,M-d),w=Math.min(g,c+_+d)-R,S=R/u,y=E/u,A=w/u,F=x/u;S<0&&(A+=S,S=0),y<0&&(F+=y,y=0);let D=s-S,L=h-y;A>D&&(A=D),F>L&&(F=L),this.log("Tile in",{x0Exp:R,y0Exp:E,wExp:w,hExp:x,core:{x:c,y:r,wCore:_,hCore:n}});try{let l={x:M-R,y:f-E,w:_,h:n},o=await this.applyFilter(t,e,i?t=>{let e=(v+Math.min(Math.max(t,0),1))/b;i(e)}:void 0,a,l,{regionOriginPx:{x:S,y:y},regionSizePx:{w:A,h:F},targetSizePx:{w:w,h:x},skipUpload:0!==c||0!==r});this.log("Tile out",{x0Exp:R,y0Exp:E,wExp:w,hExp:x});let s=o.data;for(let t=0;t<n;t++){let e=t*_*4,r=((f+t)*g+M)*4;m.set(s.subarray(e,e+4*_),r)}}catch(e){this.warnLog("Tile processing failed; backing off tile size",e);let t=Math.max(128,Math.floor(Math.min(T,T)/2));if(t<Math.min(T,T)&&o<3)return p(t,o+1);throw e}v++,l&&l(v,b),i&&i(v/b)}}let w=new ImageData(m,g,c);return i&&i(1),w};return p(null!=(o=null==r?void 0:r.tileSize)?o:0,0)}testFramebufferCapabilities(){if(this.contextLost||this.gl.isContextLost())throw Error("Cannot test framebuffer: WebGL context lost");let t=this.gl.createTexture();if(!t)throw Error("Cannot create test texture");this.gl.bindTexture(this.gl.TEXTURE_2D,t);let e=this.gl.RGBA8;try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,e,256,256,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);let r=this.gl.createFramebuffer();if(!r)throw this.gl.deleteTexture(t),Error("Cannot create test framebuffer");this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,t,0);let i=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.deleteFramebuffer(r),this.gl.deleteTexture(t),i!==this.gl.FRAMEBUFFER_COMPLETE)throw Error("Framebuffer test failed with status: ".concat(i));this.log("Framebuffer capabilities test passed")}catch(e){throw this.gl.deleteTexture(t),e}}createShader(t,e){let r=this.gl.createShader(t);if(!r)return null;if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){let e=this.gl.getShaderInfoLog(r)||"unknown error",i=t===this.gl.VERTEX_SHADER?"VERTEX":"FRAGMENT";console.error("Shader compilation error:",e);try{this.buildNotes.push("[".concat(i,"] compile error: ").concat(e))}catch(t){}return this.gl.deleteShader(r),null}return r}createProgram(t,e){let r=this.createShader(this.gl.VERTEX_SHADER,t),i=this.createShader(this.gl.FRAGMENT_SHADER,e);if(!r||!i)return null;let a=this.gl.createProgram();if(!a)return null;if(this.gl.attachShader(a,r),this.gl.attachShader(a,i),this.gl.linkProgram(a),!this.gl.getProgramParameter(a,this.gl.LINK_STATUS)){let t=this.gl.getProgramInfoLog(a)||"unknown error";console.error("Program linking error:",t);try{this.buildNotes.push("[PROGRAM] link error: ".concat(t))}catch(t){}return this.gl.deleteProgram(a),null}return this.gl.deleteShader(r),this.gl.deleteShader(i),a}initializeGL(){if(this.buildNotes=[],this.fastProgram=this.createProgram("#version 300 es\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_texCoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texCoord = a_texCoord;\n}","#version 300 es\nprecision highp float;\n\nin vec2 v_texCoord;\nout vec4 fragColor;\n\nuniform sampler2D u_image;\nuniform vec2 u_resolution;     // source texture size in pixels\nuniform vec2 u_regionOriginPx; // top-left in source pixels (ignored for full-frame)\nuniform vec2 u_regionSizePx;   // size in source pixels (ignored for full-frame)\n\n// Core controls\nuniform float u_kernelSize;     // base kernel size in px\nuniform float u_kernelScale;    // external scale (e.g., upscale)\nuniform float u_anisotropy;     // elongation factor\nuniform float u_sharpness;      // crispness\nuniform float u_alpha;          // blend amount\nuniform float u_threshold;      // detail sensitivity\nuniform float u_sigmaSpatial;   // spatial sigma factor\nuniform float u_sigmaRange;     // range sigma (0..1)\n// Painterly controls (brush-like)\nuniform int   u_sectors;        // number of sectors (1..8)\nuniform float u_order;          // generalized order p\nuniform float u_adaptStrength;  // 0..1 detail adaptation\nuniform float u_radiusMinScale; // min radius scale\nuniform float u_radiusMaxScale; // max radius scale\nuniform float u_flowSigma;      // flow smoothing radius (px)\nuniform int   u_quantizeLevels; // palette levels (0=off)\nuniform float u_quantizeStrength; // 0..1\nuniform float u_quantizeDither;  // 0..1\nuniform float u_softTau;        // soft-min temperature (<=0 hard min)\nuniform float u_edgeSigma;      // XDoG sigma\nuniform float u_edgeTau;        // XDoG threshold\nuniform float u_edgePhi;        // XDoG slope\nuniform float u_edgeMix;        // 0..1 ink amount\nuniform float u_maxRadius;      // safety cap\n\n// Tight caps to keep this variant fast but painterly\nconst int MAX_RADIUS  = 24;\nconst int MAX_SECTORS = 8;\nconst int MAX_FLOW_R  = 6;\nconst float TWO_PI = 6.28318530718;\n\nfloat luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }\n\nvec2 gradAt(vec2 uv, vec2 texel){\n    float lL = luma(texture(u_image, uv - vec2(texel.x, 0.0)).rgb);\n    float lR = luma(texture(u_image, uv + vec2(texel.x, 0.0)).rgb);\n    float lU = luma(texture(u_image, uv - vec2(0.0, texel.y)).rgb);\n    float lD = luma(texture(u_image, uv + vec2(0.0, texel.y)).rgb);\n    return vec2(lR - lL, lD - lU) * 0.5;\n}\n\n// Structure tensor smoothing for coherent flow\nvec2 flowDir(vec2 uv, vec2 texel){\n    int r = int(clamp(floor(u_flowSigma), 0.0, float(MAX_FLOW_R)));\n    if (r <= 0){\n        vec2 g = gradAt(uv, texel);\n        vec2 n = normalize(g + 1e-6);\n        return vec2(-n.y, n.x);\n    }\n    float sigma = max(0.5, u_flowSigma);\n    float twoSigma2 = 2.0 * sigma * sigma;\n    float Jxx=0.0, Jxy=0.0, Jyy=0.0, wSum=0.0;\n    for (int dy=-MAX_FLOW_R; dy<=MAX_FLOW_R; ++dy){\n        if (abs(dy) > r) continue;\n        for (int dx=-MAX_FLOW_R; dx<=MAX_FLOW_R; ++dx){\n            if (abs(dx) > r) continue;\n            vec2 d = vec2(float(dx), float(dy));\n            float w = exp(-dot(d,d)/twoSigma2);\n            vec2 g = gradAt(uv + d*texel, texel);\n            Jxx += w*g.x*g.x; Jxy += w*g.x*g.y; Jyy += w*g.y*g.y; wSum += w;\n        }\n    }\n    if (wSum > 0.0){ Jxx/=wSum; Jxy/=wSum; Jyy/=wSum; }\n    float ang = 0.5 * atan(2.0*Jxy, Jxx - Jyy);\n    vec2 gdir = vec2(cos(ang), sin(ang));\n    vec2 t = vec2(-gdir.y, gdir.x);\n    return normalize(t + 1e-6);\n}\n\n// Limited Gaussian blur for luma (used by XDoG)\nfloat blurLuma(vec2 uv, vec2 texel, float sigma){\n    float s = max(0.001, sigma);\n    int r = int(clamp(ceil(3.0*s), 1.0, float(MAX_FLOW_R)));\n    float twoSigma2 = 2.0 * s * s;\n    float sum=0.0, wSum=0.0;\n    for (int dy=-MAX_FLOW_R; dy<=MAX_FLOW_R; ++dy){\n        if (abs(dy) > r) continue;\n        for (int dx=-MAX_FLOW_R; dx<=MAX_FLOW_R; ++dx){\n            if (abs(dx) > r) continue;\n            vec2 d = vec2(float(dx), float(dy));\n            float w = exp(-dot(d,d)/twoSigma2);\n            sum += w * luma(texture(u_image, uv + d*texel).rgb);\n            wSum += w;\n        }\n    }\n    return (wSum>0.0) ? (sum/wSum) : luma(texture(u_image, uv).rgb);\n}\n\nvec3 quantize(vec3 c, int levels, float k){\n    if (levels <= 1) return c;\n    vec3 q = floor(c * float(levels)) / float(levels);\n    return mix(c, q, clamp(k,0.0,1.0));\n}\n\nfloat rnd(vec2 p){\n    p = fract(p * vec2(123.34, 345.45));\n    p += dot(p, p + 34.345);\n    return fract(p.x * p.y);\n}\n\nvoid main(){\n    vec2 texel = 1.0 / u_resolution;\n    // Compute UV in top-origin space first, then flip Y for GL sampling\n    vec2 uvTop = (u_regionSizePx.x > 0.0)\n        ? (u_regionOriginPx + v_texCoord * u_regionSizePx) / u_resolution\n        : v_texCoord;\n    vec2 uv = vec2(uvTop.x, 1.0 - uvTop.y);\n    vec3 src = texture(u_image, uv).rgb;\n\n    // Effective radius with adaptive mapping\n    float rBase = max(1.0, (u_kernelSize * u_kernelScale) * 0.5);\n    vec2 g = gradAt(uv, texel);\n    float gmag = length(g);\n    float detail = smoothstep(u_threshold * 0.25, u_threshold * 3.0, gmag);\n    float rScale = mix(u_radiusMaxScale, u_radiusMinScale, clamp(detail * u_adaptStrength, 0.0, 1.0));\n    float rEff = min(clamp(rBase * rScale, 1.0, float(MAX_RADIUS)), max(1.0, u_maxRadius));\n    int radius = int(floor(rEff));\n\n    // Flow-guided anisotropy (smoothed)\n    vec2 t = flowDir(uv, texel);\n    float theta = atan(t.y, t.x);\n    float ax = max(1.0, u_anisotropy);\n    float c = cos(theta), s = sin(theta);\n    mat2 R = mat2(c,-s,s,c);\n    mat2 A = R * mat2(ax,0.0,0.0,1.0/ax) * mat2(c,s,-s,c);\n\n    // Painterly sectors\n    int K = clamp(u_sectors, 1, MAX_SECTORS);\n    float stepAng = TWO_PI / float(K);\n    vec2 sectorDirs[MAX_SECTORS];\n    for (int i=0;i<MAX_SECTORS;++i){\n        if (i>=K) break;\n        float ang = float(i) * stepAng;\n        sectorDirs[i] = vec2(cos(ang), sin(ang));\n    }\n\n    // Bilateral weights with sharpness impacting spatial sigma\n    float sigmaS = (max(0.001, u_sigmaSpatial) * rEff) / max(0.5, u_sharpness);\n    float invTwoSigmaS2 = 1.0 / (2.0 * sigmaS * sigmaS);\n    float sigmaR = max(0.02, u_sigmaRange);\n    float invTwoSigmaR2 = 1.0 / (2.0 * sigmaR * sigmaR);\n    float srcL = luma(src);\n\n    vec3  sum[MAX_SECTORS];\n    vec3  sumSq[MAX_SECTORS];\n    float wSum[MAX_SECTORS];\n    for (int i=0;i<MAX_SECTORS;++i){ sum[i]=vec3(0.0); sumSq[i]=vec3(0.0); wSum[i]=0.0; }\n\n    for (int dy=-MAX_RADIUS; dy<=MAX_RADIUS; ++dy){\n        for (int dx=-MAX_RADIUS; dx<=MAX_RADIUS; ++dx){\n            if (abs(dx)>radius || abs(dy)>radius) continue;\n            vec2 d = vec2(float(dx), float(dy));\n            vec2 da = A * d;\n            float md = -1e9; int si = 0;\n            for (int i=0;i<MAX_SECTORS;++i){ if (i>=K) break; float dv = dot(da, sectorDirs[i]); if (dv>md){ md=dv; si=i; } }\n            float dsq = dot(da,da);\n            float wS = exp(-dsq * invTwoSigmaS2);\n            vec3 cs = texture(u_image, uv + d*texel).rgb;\n            float dl = luma(cs) - srcL;\n            float wR = exp(-(dl*dl) * invTwoSigmaR2);\n            float w = wS * wR;\n            sum[si]   += cs * w;\n            sumSq[si] += cs * cs * w;\n            wSum[si]  += w;\n        }\n    }\n\n    // Sector energies and soft/hard selection\n    vec3 means[MAX_SECTORS];\n    float vals[MAX_SECTORS];\n    for (int i=0;i<MAX_SECTORS;++i){ means[i]=vec3(0.0); vals[i]=1e9; }\n    float vMin = 1e9;\n    float p = max(0.0, u_order);\n    for (int i=0;i<MAX_SECTORS;++i){\n        if (i>=K) break;\n        if (wSum[i] <= 0.0) { vals[i]=1e9; continue; }\n        float wc = wSum[i];\n        vec3 m = sum[i] / wc;\n        vec3 vv = max(sumSq[i]/wc - m*m, vec3(0.0));\n        float v = pow(vv.r + vv.g + vv.b, 0.5*(1.0+p));\n        means[i] = m; vals[i]=v; vMin=min(vMin, v);\n    }\n\n    vec3 painted;\n    if (u_softTau > 0.0){\n        float tau = max(1e-4, u_softTau);\n        float wsum = 0.0; vec3 acc=vec3(0.0);\n        for (int i=0;i<MAX_SECTORS;++i){ if (i>=K) break; if (vals[i] >= 1e8) continue; float w = exp(-(vals[i]-vMin)/tau); acc += means[i]*w; wsum += w; }\n        painted = (wsum>0.0) ? acc/wsum : src;\n    } else {\n        float bestV=1e9; vec3 bestM=src; for (int i=0;i<MAX_SECTORS;++i){ if (i>=K) break; if (vals[i] < bestV){ bestV=vals[i]; bestM=means[i]; } } painted = bestM;\n    }\n\n    // XDoG overlay\n    if (u_edgeMix > 0.0 && u_edgeSigma > 0.0){\n        float s1 = max(0.2, u_edgeSigma);\n        float s2 = s1 * 1.6;\n        float L1 = blurLuma(uv, texel, s1);\n        float L2 = blurLuma(uv, texel, s2);\n        float dog = L1 - L2;\n        float xd = 0.5 * (1.0 + tanh(u_edgePhi * (dog - u_edgeTau)));\n        float ink = clamp(1.0 - xd, 0.0, 1.0);\n        painted *= (1.0 - u_edgeMix * ink);\n    }\n\n    // Quantization with dither\n    if (u_quantizeLevels > 1){\n        vec2 pix = floor(uv * u_resolution + 0.5);\n        float amp = clamp(u_quantizeDither, 0.0, 1.0) / float(max(1, u_quantizeLevels));\n        float n = rnd(pix);\n        vec3 dpaint = clamp(painted + (n - 0.5) * amp, 0.0, 1.0);\n        painted = quantize(dpaint, u_quantizeLevels, u_quantizeStrength);\n    }\n\n    vec3 outRgb = mix(src, painted, clamp(u_alpha, 0.0, 2.0));\n    fragColor = vec4(outRgb, 1.0);\n}"),!this.fastProgram)throw Error("Failed to create shader programs");let t=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);this.quadBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let e=this.gl;this.fastVAO=e.createVertexArray(),e.bindVertexArray(this.fastVAO);let r=this.gl.getAttribLocation(this.fastProgram,"a_position"),i=this.gl.getAttribLocation(this.fastProgram,"a_texCoord");this.gl.enableVertexAttribArray(r),this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(r,2,this.gl.FLOAT,!1,16,0),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,8),e.bindVertexArray(null)}createTexture(t,e){let r=this.gl.createTexture();if(!r)return console.error("Failed to create texture"),null;this.gl.bindTexture(this.gl.TEXTURE_2D,r);try{let i=this.gl;i.texStorage2D(i.TEXTURE_2D,1,i.RGBA8,t,e);let a=this.gl.getError();if(a!==this.gl.NO_ERROR)try{this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);let i=this.gl.getError();if(i!==this.gl.NO_ERROR)return console.error("WebGL error creating texture (both texStorage2D and texImage2D failed):",a,i),this.gl.deleteTexture(r),null}catch(t){return console.error("Exception creating texture (texImage2D fallback):",t),this.gl.deleteTexture(r),null}return this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),r}catch(t){return console.error("Exception creating texture:",t),this.gl.deleteTexture(r),null}}ensureRenderTargetAtLeast(t,e){if(this.contextLost||this.gl.isContextLost())throw Error("Cannot create framebuffer: WebGL context lost");let r=t+1&-2,i=e+1&-2;this.disposeRenderTarget();let a=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),l=this.gl.getParameter(this.gl.MAX_RENDERBUFFER_SIZE),n=Math.min("number"==typeof a?a:0,"number"==typeof l?l:0);if(!Number.isFinite(n)||n<=0)throw Error("WebGL limits unavailable; context may be lost.");if(r>n||i>n)throw Error("Target ".concat(r,"\xd7").concat(i," exceeds device limit ").concat(n));if(this.outputTexture=this.createTexture(r,i),this.outputTexture)if(this.framebuffer=this.gl.createFramebuffer(),this.framebuffer){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.outputTexture,0),this.gl.drawBuffers([this.gl.COLOR_ATTACHMENT0]);let a=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(a===this.gl.FRAMEBUFFER_COMPLETE){this.rtWidth=r,this.rtHeight=i,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);return}console.error("Texture FBO not complete, falling back to renderbuffer:",a,{dimensions:"".concat(t,"\xd7").concat(e)}),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteTexture(this.outputTexture),this.framebuffer=null,this.outputTexture=null}else this.gl.deleteTexture(this.outputTexture),this.outputTexture=null;{if(this.framebuffer=this.gl.createFramebuffer(),!this.framebuffer)throw Error("Failed to create framebuffer (renderbuffer path)");if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.outputRenderbuffer=this.gl.createRenderbuffer(),!this.outputRenderbuffer)throw this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.deleteFramebuffer(this.framebuffer),this.framebuffer=null,Error("Failed to create renderbuffer for framebuffer");this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.outputRenderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8,r,i),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,this.outputRenderbuffer),this.gl.drawBuffers([this.gl.COLOR_ATTACHMENT0]);let a=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(a!==this.gl.FRAMEBUFFER_COMPLETE){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteRenderbuffer(this.outputRenderbuffer),this.framebuffer=null,this.outputRenderbuffer=null;let r="Framebuffer not complete: ";switch(a){case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:r+="FRAMEBUFFER_INCOMPLETE_ATTACHMENT";break;case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:r+="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";break;case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:r+="FRAMEBUFFER_INCOMPLETE_DIMENSIONS";break;case this.gl.FRAMEBUFFER_UNSUPPORTED:r+="FRAMEBUFFER_UNSUPPORTED";break;default:r+="Unknown error code: ".concat(a)}throw console.error(r,{dimensions:"".concat(t,"\xd7").concat(e),webglVersion:"WebGL2",framebufferStatus:a}),Error(r)}this.rtWidth=r,this.rtHeight=i,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}}disposeRenderTarget(){try{this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}catch(t){}if(this.framebuffer){try{this.gl.deleteFramebuffer(this.framebuffer)}catch(t){}this.framebuffer=null}if(this.outputTexture){try{this.gl.deleteTexture(this.outputTexture)}catch(t){}this.outputTexture=null}if(this.outputRenderbuffer){try{this.gl.deleteRenderbuffer(this.outputRenderbuffer)}catch(t){}this.outputRenderbuffer=null}this.rtWidth=0,this.rtHeight=0}async applyFilter(t,e,r,i,a,l){this.info("applyFilter:start");let n={startedAt:this.now(),userAgent:"undefined"!=typeof navigator?navigator.userAgent:void 0,webglVersion:(()=>{try{return String(this.gl.getParameter(this.gl.VERSION))}catch(t){return}})(),shadingLanguage:(()=>{try{return String(this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION))}catch(t){return}})(),extensions:(()=>{try{return(this.gl.getSupportedExtensions()||[]).slice().sort()}catch(t){return[]}})(),limits:(()=>{try{let t=this.gl.getParameter(this.gl.MAX_VIEWPORT_DIMS);return{MAX_TEXTURE_SIZE:this.maxTextureSize,MAX_RENDERBUFFER_SIZE:this.maxRenderbufferSize,MAX_VIEWPORT_DIMS:t}}catch(t){return{}}})(),notes:[],errors:[]};try{var o,s,h,u,g,c,f,d,m,E,p,x,_,M,R,T,v,b,w,S,y,A,F,D,L,I,U,O,P,N,X,C,B,z,k,G,q,W,V,H,Q;try{try{n.vendor=String(this.gl.getParameter(this.gl.VENDOR))}catch(t){}try{n.renderer=String(this.gl.getParameter(this.gl.RENDERER))}catch(t){}if(!("undefined"!=typeof navigator&&/firefox/i.test(navigator.userAgent))){let t=this.gl.getExtension("WEBGL_debug_renderer_info");if(t){try{n.vendor=String(this.gl.getParameter(t.UNMASKED_VENDOR_WEBGL))}catch(t){}try{n.renderer=String(this.gl.getParameter(t.UNMASKED_RENDERER_WEBGL))}catch(t){}}}}catch(t){}if(this.contextLost||this.gl.isContextLost())throw this.warnLog("applyFilter: context lost at entry"),n.failedStep="entry",Error("WebGL context lost");let J=t.width,K=t.height,Y=Math.min(3,e.upscaleFactor),Z=Math.floor(J*Y),j=Math.floor(K*Y),$=e.preserveSettings?{...e,kernelSize:e.kernelSize,anisotropy:e.anisotropy,sharpness:e.sharpness,alpha:e.alpha,threshold:e.threshold}:{...e,kernelSize:Math.max(4,Math.floor(e.kernelSize*e.upscaleFactor))};if(this.log("applyFilter: sizes",{originalSize:"".concat(J,"\xd7").concat(K),targetSize:"".concat(Z,"\xd7").concat(j),upscaleFactor:Y,preserveSettings:e.preserveSettings,originalKernel:e.kernelSize,adjustedKernel:$.kernelSize}),n.originalSize={w:J,h:K},n.targetSize={w:Math.max(1,Math.floor(null!=(m=null==l||null==(o=l.targetSizePx)?void 0:o.w)?m:J)),h:Math.max(1,Math.floor(null!=(E=null==l||null==(s=l.targetSizePx)?void 0:s.h)?E:K))},n.upscaleFactor=Y,n.mode="fast",this.buildNotes&&this.buildNotes.length&&(n.notes=[...n.notes||[],...this.buildNotes]),null==i?void 0:i.aborted)throw n.failedStep="precheck-cancelled",Error("Operation cancelled");let tt=t,te=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),tr=this.gl.getParameter(this.gl.MAX_RENDERBUFFER_SIZE),ti=Math.min("number"==typeof te?te:0,"number"==typeof tr?tr:0),ta=Math.min(this.maxTextureSize||1/0,this.maxRenderbufferSize||1/0),tl=Number.isFinite(ta)&&ta>0?ta:ti;if(!Number.isFinite(ti)||ti<=0)throw n.failedStep="limits-query",Error("Unable to query WebGL limits; context may be lost.");let tn=Math.max(1,Math.floor(tl));if(tt.width>tn||tt.height>tn){let t=Math.min(tn/tt.width,tn/tt.height),e=Math.max(1,Math.floor(tt.width*t)),r=Math.max(1,Math.floor(tt.height*t));this.warnLog("Input too large (".concat(tt.width,"x").concat(tt.height,"). Downscaling to ").concat(e,"x").concat(r," to fit device limits (max ").concat(tn,").")),null==(p=n.notes)||p.push("downscaled ".concat(tt.width,"x").concat(tt.height," -> ").concat(e,"x").concat(r));let i=this.createCanvas2D(tt.width,tt.height);i.ctx.putImageData(tt,0,0);let a=this.createCanvas2D(e,r);a.ctx.imageSmoothingEnabled=!0;try{a.ctx.imageSmoothingQuality="high"}catch(t){}let l=i.canvas;a.ctx.drawImage(l,0,0,e,r),tt=a.ctx.getImageData(0,0,e,r)}let to=Math.max(1,Math.floor(null!=(x=null==l||null==(h=l.targetSizePx)?void 0:h.w)?x:tt.width)),ts=Math.max(1,Math.floor(null!=(_=null==l||null==(u=l.targetSizePx)?void 0:u.h)?_:tt.height));this.log("applyFilter:target",{tgtW:to,tgtH:ts});try{let t=this.canvasEl;t.width!==to&&(t.width=to),t.height!==ts&&(t.height=ts)}catch(t){}this.gl.viewport(0,0,to,ts),n.usedDefaultFramebuffer=!0,n.readbackMethod="2d-drawImage";let th=this.now();this.log("upload:start"),this.texture||(this.texture=this.gl.createTexture(),this.inputTexW=0,this.inputTexH=0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);let tu=this.gl;if(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,4),!(null==l?void 0:l.skipUpload)){if(this.inputTexW<tt.width||this.inputTexH<tt.height){this.log("upload:alloc:new",{w:tt.width,h:tt.height});try{this.texture&&this.gl.deleteTexture(this.texture)}catch(t){}this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,tt.width,tt.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);let t=0;try{t=this.gl.getError()}catch(t){}if(t!==this.gl.NO_ERROR){this.warnLog("upload:alloc:texImage2D(null) failed",t),null==(M=n.errors)||M.push({where:"texImage2D(null)",code:t,label:this.glErrorLabel(t)});try{tu.texStorage2D(tu.TEXTURE_2D,1,tu.RGBA8,tt.width,tt.height)}catch(t){}let e=0;try{e=this.gl.getError()}catch(t){}if(e!==this.gl.NO_ERROR)throw this.errLog("upload:alloc:texStorage2D failed",e),null==(R=n.errors)||R.push({where:"texStorage2D",code:e,label:this.glErrorLabel(e)}),n.failedStep="input-texture-alloc",Error("INPUT_TEX_ALLOC_FAILED")}this.inputTexW=tt.width,this.inputTexH=tt.height}try{this.log("upload:subimage:start",{w:tt.width,h:tt.height}),tu.texSubImage2D(tu.TEXTURE_2D,0,0,0,tt.width,tt.height,tu.RGBA,tu.UNSIGNED_BYTE,tt.data),this.log("upload:subimage:done")}catch(t){throw this.errLog("texSubImage2D error",t),n.failedStep="texSubImage2D",n.exception=String(t),Error("UPLOAD_SUBIMAGE_FAILED")}}if(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),n.timings=n.timings||{},n.timings.upload=this.now()-th,r&&r(.5),null==i?void 0:i.aborted)throw n.failedStep="pre-draw-cancelled",Error("Operation cancelled");this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);try{this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,null)}catch(t){}this.gl.viewport(0,0,to,ts),this.gl.disable(this.gl.BLEND);let tg=this.fastProgram,tc=this.fastVAO;if(!tg||!tc)throw Error("Shader program/VAO not initialized");this.log("draw:setup",{mode:"fast"}),this.gl.useProgram(tg),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT);try{for(;this.gl.getError()!==this.gl.NO_ERROR;);}catch(t){}this.gl.bindVertexArray(tc);let tf=(t,e)=>{let r=this.gl.getUniformLocation(tg,t);r&&this.gl.uniform1i(r,e)},td=(t,e)=>{let r=this.gl.getUniformLocation(tg,t);r&&this.gl.uniform1f(r,e)},tm=(t,e,r)=>{let i=this.gl.getUniformLocation(tg,t);i&&this.gl.uniform2f(i,e,r)};this.log("applyFilter: uniforms",{webglVersion:"WebGL2",kernelSize:$.kernelSize,anisotropy:$.anisotropy,sharpness:$.sharpness,alpha:$.alpha,threshold:$.threshold,resolution:"".concat(tt.width,"x").concat(tt.height),kernelScale:e.preserveSettings?Y:1}),n.uniforms={u_kernelSize:$.kernelSize,u_anisotropy:$.anisotropy,u_sharpness:$.sharpness,u_alpha:$.alpha,u_threshold:$.threshold,u_resolution_w:tt.width,u_resolution_h:tt.height,u_kernelScale:e.preserveSettings?Y:1},tf("u_image",0),tm("u_resolution",t.width,t.height);let tE=null!=(T=null==l||null==(g=l.regionOriginPx)?void 0:g.x)?T:0,tp=null!=(v=null==l||null==(c=l.regionOriginPx)?void 0:c.y)?v:0,tx=null!=(b=null==l||null==(f=l.regionSizePx)?void 0:f.w)?b:0,t_=null!=(w=null==l||null==(d=l.regionSizePx)?void 0:d.h)?w:0;tm("u_regionOriginPx",tE,tp),tm("u_regionSizePx",tx,t_);let tM=e.preserveSettings?Y:1;td("u_kernelSize",$.kernelSize),td("u_kernelScale",tM),td("u_anisotropy",$.anisotropy),td("u_sharpness",$.sharpness),td("u_alpha",$.alpha),td("u_threshold",$.threshold);let tR=Math.max(1,Math.min(8,Math.round(null!=(S=e.sectors)?S:4))),tT=null!=(y=e.order)?y:1,tv=null!=(A=e.sigmaSpatial)?A:.5,tb=null!=(F=e.sigmaRange)?F:.15,tw=null!=(D=e.adaptStrength)?D:.75,tS=null!=(L=e.radiusMinScale)?L:.35,ty=null!=(I=e.radiusMaxScale)?I:1,tA=null!=(U=e.flowSigma)?U:2,tF=Math.max(0,Math.round(null!=(O=e.quantizeLevels)?O:0)),tD=null!=(P=e.quantizeStrength)?P:.6,tL=null!=(N=e.quantizeDither)?N:.35;tf("u_sectors",tR),td("u_order",tT),td("u_sigmaSpatial",tv),td("u_sigmaRange",tb),td("u_adaptStrength",tw),td("u_radiusMinScale",tS),td("u_radiusMaxScale",ty),td("u_flowSigma",tA),tf("u_quantizeLevels",tF),td("u_quantizeStrength",tD),td("u_quantizeDither",tL);let tI=null!=(X=e.softTau)?X:0,tU=null!=(C=e.edgeSigma)?C:0,tO=null!=(B=e.edgeTau)?B:0,tP=null!=(z=e.edgePhi)?z:10,tN=null!=(k=e.edgeMix)?k:0;td("u_softTau",tI),td("u_edgeSigma",tU),td("u_edgeTau",tO),td("u_edgePhi",tP),td("u_edgeMix",tN);let tX=Math.min(24,Math.max(8,Math.floor($.kernelSize*tM*(e.anisotropy>1?.5:.75))));td("u_maxRadius",tX),this.log("uniforms:painterly",{sectors:tR,order:tT,sigmaSpatial:tv,sigmaRange:tb,adaptStrength:tw,radiusMinScale:tS,radiusMaxScale:ty,flowSigma:tA,quantizeLevels:tF,quantizeStrength:tD,quantizeDither:tL,softTau:tI,edgeSigma:tU,edgeTau:tO,edgePhi:tP,edgeMix:tN});let tC=null,tB=!1,tz=null;try{(tB=!!(tz=this.gl.getExtension("EXT_disjoint_timer_query_webgl2")||this.gl.getExtension("EXT_disjoint_timer_query"))&&"function"==typeof this.gl.beginQuery)&&(tC=this.gl.createQuery(),this.gl.beginQuery(tz.TIME_ELAPSED_EXT,tC))}catch(t){}let tk=this.now();this.log("draw:start"),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),this.log("draw:done");try{this.gl.flush()}catch(t){}try{tB&&this.gl.endQuery(tz.TIME_ELAPSED_EXT)}catch(t){}{let t=this.gl.getError();if(t!==this.gl.NO_ERROR)throw this.errLog("drawArrays error",t),null==(G=n.errors)||G.push({where:"drawArrays",code:t,label:this.glErrorLabel(t)}),n.failedStep="draw",Error("DRAW_FAILED_".concat(t))}if(n.timings=n.timings||{},n.timings.draw=this.now()-tk,tB&&tC){try{let t=this.now();for(;!this.gl.getQueryParameter(tC,this.gl.QUERY_RESULT_AVAILABLE)&&this.now()-t<20;)await new Promise(t=>setTimeout(t,1));if(this.gl.getQueryParameter(tC,this.gl.QUERY_RESULT_AVAILABLE)){n.gpuTimeNs=this.gl.getQueryParameter(tC,this.gl.QUERY_RESULT);let t=tz;if(t&&"number"==typeof t.GPU_DISJOINT_EXT)try{n.gpuDisjoint=!!this.gl.getParameter(t.GPU_DISJOINT_EXT)}catch(t){}}else null==(q=n.notes)||q.push("GPU timer query not ready within 20ms")}catch(t){}try{this.gl.deleteQuery(tC)}catch(t){}}if(r&&r(.8),null==i?void 0:i.aborted)throw Error("Operation cancelled");let tG=this.now();this.log("readback:start");let tq=Math.max(0,Math.floor(null!=(W=null==a?void 0:a.x)?W:0)),tW=Math.max(0,Math.floor(null!=(V=null==a?void 0:a.y)?V:0)),tV=Math.max(1,Math.floor(null!=(H=null==a?void 0:a.w)?H:to)),tH=Math.max(1,Math.floor(null!=(Q=null==a?void 0:a.h)?Q:ts)),tQ=new OffscreenCanvas(tV,tH).getContext("2d",{willReadFrequently:!0});if(!tQ)throw n.failedStep="2d-context",Error("2D_CTX_FAIL");let tJ=this.canvasEl;tQ.drawImage(tJ,tq,tW,tV,tH,0,0,tV,tH);let tK=tQ.getImageData(0,0,tV,tH);n.timings.readback=this.now()-tG,this.log("readback:done",{rw:tV,rh:tH}),r&&r(1),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindVertexArray(null),this.gl.bindTexture(this.gl.TEXTURE_2D,null);try{this.disposeRenderTarget()}catch(t){}if(this.texture){try{this.gl.deleteTexture(this.texture)}catch(t){}this.texture=null,this.inputTexW=0,this.inputTexH=0}return n.finishedAt=this.now(),n.durationMs=n.finishedAt-n.startedAt,n.timings=n.timings||{},n.timings.total=n.durationMs,this.lastReport=n,this.log("applyFilter:done",{durationMs:n.durationMs}),tK}catch(t){this.errLog("applyFilter:error",t);try{n.finishedAt=this.now(),n.durationMs=n.finishedAt-n.startedAt,n.exception=t instanceof Error?t.stack||t.message:String(t),this.lastReport=n}catch(t){}throw t}}async upscaleImageData(t,e){return new Promise(r=>{let i=document.createElement("canvas"),a=i.getContext("2d"),l=Math.floor(t.width*e),n=Math.floor(t.height*e);i.width=l,i.height=n;let o=document.createElement("canvas"),s=o.getContext("2d");o.width=t.width,o.height=t.height,s.putImageData(t,0,0),a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(o,0,0,l,n),r(a.getImageData(0,0,l,n))})}renderToCanvas(t,e){let r=t.getContext("2d",{willReadFrequently:!1});if(!r)throw Error("2D context not available for display");t.width=e.width,t.height=e.height,r.imageSmoothingEnabled=!1,r.putImageData(e,0,0)}destroy(){try{this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindVertexArray(null)}catch(t){}if(this.quadBuffer)try{this.gl.deleteBuffer(this.quadBuffer)}catch(t){}if(this.fastVAO)try{this.gl.deleteVertexArray(this.fastVAO)}catch(t){}if(this.disposeRenderTarget(),this.texture){try{this.gl.deleteTexture(this.texture)}catch(t){}this.texture=null}this.inputTexW=0,this.inputTexH=0;try{this.canvasEl.width=0,this.canvasEl.height=0}catch(t){}}constructor(t){this.contextLost=!1,this.maxTextureSize=0,this.maxRenderbufferSize=0,this.prefer2DReadback=!0,this.lastReport=null,this.buildNotes=[],this.fastProgram=null,this.framebuffer=null,this.texture=null,this.outputTexture=null,this.outputRenderbuffer=null,this.quadBuffer=null,this.fastVAO=null,this.rtWidth=0,this.rtHeight=0,this.inputTexW=0,this.inputTexH=0,(0===t.width||0===t.height)&&(t.width=256,t.height=256);let e=t.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1});if(!e){try{let e=null,r=!1;"parentNode"in t&&(e=t.parentNode,"undefined"!=typeof document&&(r=document.contains(t)));let i="undefined"!=typeof navigator?navigator.userAgent:"n/a";console.error("Failed to create WebGL2 context:",{canvasWidth:t.width,canvasHeight:t.height,canvasParent:e,canvasInDOM:r,userAgent:i})}catch(t){}throw Error("WebGL2 is required but not supported by your browser/system")}this.gl=e,this.canvasEl=t;let r=this.canvasEl;"addEventListener"in r&&(r.addEventListener("webglcontextlost",t=>{try{t.preventDefault()}catch(t){}this.contextLost=!0,console.warn("WebGL context lost")},{passive:!1}),r.addEventListener("webglcontextrestored",()=>{console.info("WebGL context restored"),this.contextLost=!1;try{this.initializeGL();try{this.testFramebufferCapabilities()}catch(t){console.warn("Post-restore FBO test failed:",t)}}catch(t){console.error("Failed to reinitialize WebGL after context restore:",t)}})),this.info("Using WebGL2");try{let t=e.getParameter(e.MAX_TEXTURE_SIZE),r=e.getParameter(e.MAX_RENDERBUFFER_SIZE);this.maxTextureSize=Number(t)||0,this.maxRenderbufferSize=Number(r)||0;let i=e.getParameter(e.MAX_VIEWPORT_DIMS);this.log("Limits",{MAX_TEXTURE_SIZE:t,MAX_RENDERBUFFER_SIZE:r,MAX_VIEWPORT_DIMS:i})}catch(t){}this.initializeGL();try{this.testFramebufferCapabilities()}catch(t){this.warnLog("Framebuffer capability test failed:",t)}}}e.DEBUG=void 0!==t&&t.env&&!1;let i=null;function a(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];try{console.log("[Worker]",...e)}catch(t){}}function l(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];try{console.info("[Worker]",...e)}catch(t){}}function n(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];try{console.warn("[Worker]",...e)}catch(t){}}function o(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];try{console.error("[Worker]",...e)}catch(t){}}self.onmessage=async t=>{let r=t.data;switch(r.type){case"init":try{l("init"),self.postMessage({type:"progress",requestId:"init",progress:1})}catch(e){let t=e instanceof Error?e.message:String(e);o("init error",t),self.postMessage({type:"error",error:t})}break;case"process":{var s,h,u,g,c,f,d,m,E,p,x,_,M,R,T,v,b,w;let t=null,S=Date.now(),y=!1,A=0,F=[];try{let o=Math.max(1,Math.floor(null!=(f=null!=(c=null==(s=r.options)?void 0:s.scale)?c:r.params.upscaleFactor)?f:1));a("process:start",{req:r.requestId,src:"".concat(r.imageData.width,"x").concat(r.imageData.height),scale:o,tileSize:null==(h=r.options)?void 0:h.tileSize});let w=null;try{w=new OffscreenCanvas(1,1),t=new e(w),l("gl:context created")}catch(r){n("gl:create failed, retrying once"),await new Promise(t=>setTimeout(t,50)),w=new OffscreenCanvas(1,1),t=new e(w),l("gl:context created (retry)")}if(i)try{i.abort()}catch(t){}i=new AbortController;let D=t=>{(0===t||.5===t||.8===t||t>=1||t-Math.floor(100*t)/100<1e-6)&&a("progress",t),self.postMessage({type:"progress",requestId:r.requestId,progress:t})},L=r.imageData,I=null==(u=r.options)?void 0:u.preprocess,U=Date.now();if(I&&I.enabled){a("preprocess:start",{blurEnabled:I.blurEnabled,blurRadius:I.blurRadius,blurAmount:I.blurAmount,saturation:I.saturation,warmth:I.warmth,tint:I.tint,brightness:I.brightness});let t=L;if(I.blurEnabled){let e=Math.max(0,Math.round(null!=(d=I.blurRadius)?d:4)),r=Math.max(0,Math.min(1,null!=(m=I.blurAmount)?m:.35));e>0&&r>0&&(t=function(t,e,r){let{width:i,height:a,data:l}=t,n=function(t,e,r,i){if(i<=0)return t.slice();let a=new Uint8ClampedArray(t.length),l=new Float32Array(e*r*3),n=2*i+1;for(let a=0;a<r;a++){let r=0,o=0,s=0;for(let l=-i;l<=i;l++){let i=Math.min(e-1,Math.max(0,l)),n=(a*e+i)*4;r+=t[n],o+=t[n+1],s+=t[n+2]}for(let h=0;h<e;h++){let u=(a*e+h)*3;l[u]=r/n,l[u+1]=o/n,l[u+2]=s/n;let g=Math.min(e-1,Math.max(0,h-i)),c=Math.min(e-1,Math.max(0,h+i+1)),f=(a*e+g)*4,d=(a*e+c)*4;r+=t[d]-t[f],o+=t[d+1]-t[f+1],s+=t[d+2]-t[f+2]}}for(let o=0;o<e;o++){let s=0,h=0,u=0;for(let t=-i;t<=i;t++){let i=(Math.min(r-1,Math.max(0,t))*e+o)*3;s+=l[i],h+=l[i+1],u+=l[i+2]}for(let g=0;g<r;g++){let c=(g*e+o)*4;a[c]=Math.round(s/n),a[c+1]=Math.round(h/n),a[c+2]=Math.round(u/n),a[c+3]=t[c+3];let f=(Math.min(r-1,Math.max(0,g-i))*e+o)*3,d=(Math.min(r-1,Math.max(0,g+i+1))*e+o)*3;s+=l[d]-l[f],h+=l[d+1]-l[f+1],u+=l[d+2]-l[f+2]}}return a}(l,i,a,e),o=new Uint8ClampedArray(l.length),s=new Float32Array(i*a);for(let t=0,e=0;t<l.length;t+=4,e++)s[e]=.2126*(l[t]/255)+.7152*(l[t+1]/255)+.0722*(l[t+2]/255);let h=1e-6,u=new Float32Array(i*a);for(let t=0;t<a;t++)for(let e=0;e<i;e++){let r=function(t,e,r,i,a){let l=(i,a)=>t[Math.max(0,Math.min(r-1,i))*e+Math.max(0,Math.min(e-1,a))],n=-l(a-1,i-1)-2*l(a,i-1)-l(a+1,i-1)+l(a-1,i+1)+2*l(a,i+1)+l(a+1,i+1);return Math.hypot(n,-l(a-1,i-1)-2*l(a-1,i)-l(a-1,i+1)+l(a+1,i-1)+2*l(a+1,i)+l(a+1,i+1))}(s,i,a,e,t);u[t*i+e]=r,r>h&&(h=r)}let g=1/h;for(let t=0;t<a;t++)for(let e=0;e<i;e++){let a=(t*i+e)*4,s=u[t*i+e]*g,h=r*(1-s)*(1-s);o[a]=Math.round(l[a]*(1-h)+n[a]*h),o[a+1]=Math.round(l[a+1]*(1-h)+n[a+1]*h),o[a+2]=Math.round(l[a+2]*(1-h)+n[a+2]*h),o[a+3]=l[a+3]}return new ImageData(o,i,a)}(t,e,r))}let e=null!=(E=I.saturation)?E:1,r=null!=(p=I.warmth)?p:0,i=null!=(x=I.tint)?x:0,l=null!=(_=I.brightness)?_:0;(Math.abs(e-1)>.001||Math.abs(r)>.001||Math.abs(i)>.001||Math.abs(l)>.001)&&(t=function(t,e,r,i,a){let{width:l,height:n,data:o}=t,s=new Uint8ClampedArray(o.length),h=Math.max(0,Math.min(2,e)),u=Math.max(-1,Math.min(1,r)),g=Math.max(-1,Math.min(1,i)),c=Math.max(0,Math.min(2,a));for(let t=0;t<o.length;t+=4){let e=o[t]/255,r=o[t+1]/255,i=o[t+2]/255,a=.2126*e+.7152*r+.0722*i,l=a+(e-a)*h,n=a+(r-a)*h,f=a+(i-a)*h;l+=.1*u,f-=.1*u,n+=-(.08*g),l+=.04*g,f+=.04*g,l*=c,n*=c,f*=c,s[t]=Math.max(0,Math.min(255,Math.round(255*l))),s[t+1]=Math.max(0,Math.min(255,Math.round(255*n))),s[t+2]=Math.max(0,Math.min(255,Math.round(255*f))),s[t+3]=o[t+3]}return new ImageData(s,l,n)}(t,e,r,i,l)),L=t,D(.05),a("preprocess:done",{out:"".concat(L.width,"x").concat(L.height)})}let O=Date.now()-U,P=Math.max(1,L.width*o),N=Math.max(1,L.height*o),X=Math.max(64,Math.min(1024,Math.floor(null!=(M=null==(g=r.options)?void 0:g.tileSize)?M:320))),C=Math.max(1,Math.ceil(P/X)),B=Math.max(1,Math.ceil(N/X)),z=C*B;a("tiling",{tgt:"".concat(P,"x").concat(N),tileSize:X,tilesX:C,tilesY:B,totalTiles:z});let k=new OffscreenCanvas(L.width,L.height),G=k.getContext("2d",{willReadFrequently:!0});if(!G)throw Error("2D context unavailable");G.putImageData(L,0,0);let q=new Uint8ClampedArray(P*N*4),W=0,V=null,H=new OffscreenCanvas(1,1),Q=H.getContext("2d",{willReadFrequently:!0});if(!Q)throw Error("2D context unavailable");for(let l=0;l<B;l++)for(let s=0;s<C;s++){let h;if(i.signal.aborted)throw y=!0,Error("Operation cancelled");let u=s*X,g=l*X,c=Math.min(X,P-u),f=Math.min(X,N-g);a("tile:start",{tx:s,ty:l,xOut:u,yOut:g,wOut:c,hOut:f});let d=u/o,m=g/o,E=c/o,p=f/o,x=Date.now();H.width=Math.max(1,Math.floor(E)),H.height=Math.max(1,Math.floor(p)),Q.imageSmoothingEnabled=!0;try{Q.imageSmoothingQuality="high"}catch(t){}Q.drawImage(k,d,m,E,p,0,0,Math.max(1,Math.floor(E)),Math.max(1,Math.floor(p)));let _=Q.getImageData(0,0,H.width,H.height),M=Date.now()-x;a("tile:gpu",{tx:s,ty:l,in:"".concat(_.width,"x").concat(_.height),out:"".concat(c,"x").concat(f)});let w=Date.now(),S=0;try{h=await t.applyFilter(_,r.params,void 0,i.signal,void 0,{targetSizePx:{w:c,h:f}})}catch(a){if(i.signal.aborted)throw y=!0,Error("Operation cancelled");try{null==t||t.destroy()}catch(t){}t=null;try{let a=new OffscreenCanvas(1,1);t=new e(a),S=1,A++,n("tile:gpu:retry",{tx:s,ty:l}),h=await t.applyFilter(_,r.params,void 0,i.signal,void 0,{targetSizePx:{w:c,h:f}})}catch(t){throw t}}let L=Date.now()-w,I=Date.now(),U=h.data;for(let t=0;t<f;t++){let e=t*c*4,r=((g+t)*P+u)*4;q.set(U.subarray(e,e+4*c),r)}let O=Date.now()-I;try{V=t.getLastReport()}catch(t){}let C=V;F.push({tx:s,ty:l,xOut:u,yOut:g,wOut:c,hOut:f,cropMs:M,composeMs:O,totalMs:M+L+O,retry:S,gpu:C?{totalMs:null==C||null==(R=C.timings)?void 0:R.total,uploadMs:null==C||null==(T=C.timings)?void 0:T.upload,drawMs:null==C||null==(v=C.timings)?void 0:v.draw,readbackMs:null==C||null==(b=C.timings)?void 0:b.readback,gpuTimeNs:null==C?void 0:C.gpuTimeNs,failedStep:null==C?void 0:C.failedStep,errors:((null==C?void 0:C.errors)||[]).map(t=>"".concat(t.where,":").concat(t.label))}:void 0}),W++,D&&D(W/z),a("tile:done",{tx:s,ty:l,tilesDone:W,totalTiles:z})}let J=new ImageData(q,P,N);try{if(V){let t={canceled:y,retries:A,overallMs:Date.now()-S,preprocessMs:O,tiling:{tilesX:C,tilesY:B,totalTiles:z,tileSize:X},tiles:F,aggregates:(()=>{let t=F.map(t=>t.totalMs||0),e=t.reduce((t,e)=>t+e,0),r=t.reduce((t,e)=>Math.max(t,e),0),i=t.findIndex(t=>t===r);return{tilesTotalMs:e,tileAvgMs:t.length?e/t.length:0,tileMaxMs:r,tileMaxIndex:i}})()};V.worker=t,V.requestId=r.requestId,a("report:post",{failedStep:V.failedStep,errors:(V.errors||[]).length}),self.postMessage({type:"report",requestId:r.requestId,report:V})}}catch(t){}a("process:done",{req:r.requestId,out:"".concat(J.width,"x").concat(J.height)}),self.postMessage({type:"result",requestId:r.requestId,imageData:J,report:null!=V?V:void 0},[J.data.buffer])}catch(l){let e=l instanceof Error?l.message:String(l);o("process:error",e);let i=null;try{i=null!=(w=null==t?void 0:t.getLastReport())?w:null}catch(t){}if(i)try{i.worker={canceled:y,retries:A,overallMs:Date.now()-S,tiles:F},i.requestId=r.requestId,a("report:post (failure)",{failedStep:i.failedStep,errors:(i.errors||[]).length}),self.postMessage({type:"report",requestId:r.requestId,report:i})}catch(t){}self.postMessage({type:"error",requestId:r.requestId,error:e,report:null!=i?i:void 0})}finally{if(t)try{t.destroy(),a("gl:destroy")}catch(t){}}break}case"cancel":if(i)try{i.abort()}catch(t){}break;case"dispose":close()}}})(),_N_E={}})();